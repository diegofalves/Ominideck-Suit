<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>OmniDeck ‚Äî Projeto de Migra√ß√£o</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; }
    fieldset { margin-bottom: 24px; padding: 16px; border: 1px solid #ccc; }
    legend { font-weight: bold; }
    label { display: block; margin-top: 8px; }
    input, select, textarea { width: 100%; max-width: 400px; }
  </style>
</head>
<body>

<h1>OmniDeck</h1>

<!-- Exibi√ß√£o de Erros de Valida√ß√£o -->
{% if errors %}
  <div style="background-color: #ffebee; border: 2px solid #c62828; color: #b71c1c; padding: 16px; border-radius: 4px; margin-bottom: 24px;">
    <h3 style="margin-top: 0; color: #b71c1c;">‚ö†Ô∏è Erros de Valida√ß√£o</h3>
    <ul style="margin: 0; padding-left: 20px;">
      {% for error in errors %}
        <li>{{ error }}</li>
      {% endfor %}
    </ul>
    <p style="font-size: 12px; margin-bottom: 0; color: #666;">
      Corrija os erros abaixo e tente novamente.
    </p>
  </div>
{% endif %}

<form method="POST">

  <!-- ========================= -->
  <!-- Identifica√ß√£o do Projeto -->
  <!-- ========================= -->
  <fieldset>
    <legend>{{ ui.project.section }}</legend>

    {% for field, cfg in ui.project.fields.items() %}
      <label>{{ cfg.label }}</label>

      {% if field == "environment_source" %}
        <input
          type="text"
          name="environment_source"
          value="{{ project.project.environment.source if project and project.project and project.project.environment else '' }}"
        >

      {% elif field == "environment_target" %}
        <input
          type="text"
          name="environment_target"
          value="{{ project.project.environment.target if project and project.project and project.project.environment else '' }}"
        >

      {% elif cfg.type == "number" %}
        <input
          type="number"
          name="{{ field }}"
          value="{{ project.project[field] if project and project.project else '' }}"
        >

      {% else %}
        <input
          type="text"
          name="{{ field }}"
          value="{{ project.project[field] if project and project.project else '' }}"
        >
      {% endif %}
    {% endfor %}
  </fieldset>

  <!-- ================= -->
  <!-- Grupos Din√¢micos -->
  <!-- ================= -->
  <fieldset>
    <legend>Grupos do Projeto</legend>

    <div id="groups-container"></div>

    <button type="button" onclick="addGroup()">‚ûï Adicionar Grupo</button>
  </fieldset>

  <!-- ================================== -->
  <!-- Seletor de Tipo de Objeto (Global) -->
  <!-- ================================== -->
  <fieldset id="object-type-container" style="display: none;">
    <legend>Tipo do Objeto</legend>
    <label>Selecione o tipo (Tabela OTM ou Tipo L√≥gico):</label>
    <select name="object_type" id="object-type-selector" class="object-type-selector">
      <!-- Op√ß√µes ser√£o injetadas por schema-engine.js -->
    </select>
  </fieldset>

  <!-- ================================== -->
  <!-- Painel Condicional - Grupo Ativo -->
  <!-- ================================== -->
  {% if project_data and project_data.active_group_id %}
    {% set active_id = project_data.active_group_id %}
    {% set active_group = groups_catalog.get(active_id) %}

    <!-- Encontrar o grupo completo do projeto -->
    {% set current_group = namespace(data=none) %}
    {% if project_data.groups %}
      {% for g in project_data.groups %}
        {% if g.group_id == active_id %}
          {% set current_group.data = g %}
        {% endif %}
      {% endfor %}
    {% endif %}

    <!-- Pegar o √≠ndice do objeto a editar -->
    {% set last_edit_index = project_data.state.get('last_edit_object_index') if project_data and project_data.state else none %}
    {% set edit_object_index = last_edit_index | int if last_edit_index is not none else -1 %}
    
    <!-- Pegar o objeto a editar (se √≠ndice v√°lido) -->
    {% set current_object = none %}
    {% if edit_object_index >= 0 and current_group.data and edit_object_index < current_group.data.objects | length %}
      {% set current_object = current_group.data.objects[edit_object_index] %}
    {% endif %}

    <fieldset style="border: 2px solid #4CAF50;">
      <legend>
        Grupo Ativo ‚Äî {{ active_group.label }}
      </legend>

      <p style="font-size: 13px; color: #555;">
        Voc√™ est√° editando o grupo
        <strong>{{ active_group.label }}</strong>
        ({{ active_group.sequence }}¬∫ no fluxo).
      </p>

      <!-- Se√ß√£o de Sele√ß√£o/Cria√ß√£o de Objeto -->
      {% if current_group.data and current_group.data.objects %}
        <label for="edit_object_index" style="font-weight: bold; margin-top: 16px;">Editar Objeto Existente</label>
        <select id="edit_object_index" name="edit_object_index" style="margin-bottom: 16px;">
          <option value="">‚Äî Criar novo objeto ‚Äî</option>

          {% for obj in current_group.data.objects %}
            <option value="{{ loop.index0 }}"
              {% if edit_object_index == loop.index0 %}selected{% endif %}
            >
              {{ obj.name or ("Objeto " ~ loop.index) }} ‚Äî {{ obj.type }} ¬∑ {{ obj.deployment_type }}
            </option>
          {% endfor %}
        </select>
      {% endif %}

      <h4>{% if edit_object_index >= 0 %}Editar Objeto{% else %}Novo Objeto{% endif %}</h4>

      <p style="font-size: 12px; color: #666; margin-bottom: 12px;">
        {% if edit_object_index >= 0 %}
          <strong>Modo: Edi√ß√£o</strong> - Alterando objeto #{{ edit_object_index + 1 }}
        {% else %}
          <strong>Modo: Cria√ß√£o</strong> - Um novo objeto ser√° adicionado ao grupo
        {% endif %}
      </p>

      <!-- Formul√°rio de Objeto -->
      <h4>Dados do Objeto</h4>

      <label><strong>Nome do Objeto *</strong></label>
      <input 
        type="text" 
        name="object_name" 
        required 
        placeholder="Ex: Query de Elegibilidade de Frete"
        value="{{ current_object.name if current_object else '' }}"
      >

      <label>Descri√ß√£o Funcional</label>
      <textarea 
        name="object_description" 
        rows="3" 
        placeholder="Explique o prop√≥sito funcional deste objeto no projeto"
        style="width: 100%; padding: 6px; font-family: Arial, sans-serif; font-size: 12px; border: 1px solid #ccc; border-radius: 3px;"
      >{{ current_object.description if current_object else '' }}</textarea>

      <label>Tipo de Deploy</label>
      <select name="object_deployment_type">
        {% for opt in enums.deployment_type %}
          <option value="{{ opt }}" {% if current_object and current_object.deployment_type == opt %}selected{% endif %}>
            {{ opt }}
          </option>
        {% endfor %}
      </select>

      <label>Respons√°vel</label>
      <input type="text" name="object_responsible" value="{{ current_object.responsible if current_object else '' }}">

      <!-- ========================================== -->
      <!-- Identificadores para Tipos L√≥gicos       -->
      <!-- ========================================== -->
      <h4 style="margin-top: 24px;">Identificadores (Tipos L√≥gicos)</h4>

      <!-- SAVED_QUERY -->
      <div id="identifier_query_name" style="display:none;">
        <label>Query Name</label>
        <input type="text" name="identifiers[query_name]" placeholder="Nome da query" value="">
      </div>

      <!-- AGENT -->
      <div id="identifier_agent_gid" style="display:none;">
        <label>Agent GID</label>
        <input type="text" name="identifiers[agent_gid]" placeholder="Identificador do agente" value="">
      </div>

      <!-- FINDER_SET -->
      <div id="identifier_finder_set_gid" style="display:none;">
        <label>Finder Set GID</label>
        <input type="text" name="identifiers[finder_set_gid]" placeholder="Identificador do Finder Set" value="">
      </div>

      <!-- RATE -->
      <div id="identifier_rate_offering_gid" style="display:none;">
        <label>Rate Offering GID</label>
        <input type="text" name="identifiers[rate_offering_gid]" placeholder="Identificador da taxa de oferta" value="">
      </div>

      <!-- EVENT_GROUP -->
      <div id="identifier_event_group_gid" style="display:none;">
        <label>Event Group GID</label>
        <input type="text" name="identifiers[event_group_gid]" placeholder="Identificador do grupo de eventos" value="">
      </div>

      <!-- ========================================== -->
      <!-- Campos Schema-Driven (Tabelas OTM)       -->
      <!-- ========================================== -->
      <div id="schema-sections-container" style="display: none;">
        <!-- Ser√° preenchido dinamicamente por schema-engine.js -->
      </div>

      <label>Observa√ß√µes T√©cnicas</label>
      <textarea name="object_notes" rows="3">{{ current_object.notes if current_object else '' }}</textarea>

      <!-- Hidden field para manter edit_object_index no POST -->
      <input type="hidden" name="edit_object_index" value="{{ edit_object_index if edit_object_index >= 0 else '' }}">

      <!-- Se√ß√£o de A√ß√µes do Objeto -->
      {% if edit_object_index >= 0 %}
        <div style="margin-top: 24px; padding: 16px; background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 4px;">
          <p style="font-size: 12px; color: #856404; margin: 0 0 12px 0;">
            <strong>A√ß√µes Dispon√≠veis:</strong>
          </p>

          <!-- Bot√£o Remover (formul√°rio separado) -->
          <form method="POST" style="display: inline;">
            <input type="hidden" name="remove_object_index" value="{{ edit_object_index }}">
            <button type="submit" style="background-color: #e53935; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
              üóëÔ∏è Remover Objeto
            </button>
          </form>

          <p style="font-size: 11px; color: #856404; margin-top: 8px;">
            ‚ö†Ô∏è Esta a√ß√£o remove permanentemente o objeto do grupo.
          </p>
        </div>
      {% endif %}>

      <!-- Lista de Objetos do Grupo Ativo -->
      {% if current_group.data and current_group.data.objects %}
        <h4 style="margin-top: 24px;">Objetos do Grupo</h4>

        <table border="1" cellpadding="6" cellspacing="0" style="border-collapse: collapse; width: 100%; max-width: 900px;">
          <thead>
            <tr style="background-color: #f5f5f5;">
              <th>#</th>
              <th>Nome Funcional</th>
              <th>Tipo ¬∑ Deploy</th>
              <th>Respons√°vel</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% for obj in current_group.data.objects %}
              <tr>
                <td>{{ loop.index }}</td>
                <td><strong>{{ obj.name or "Sem nome" }}</strong></td>
                <td>{{ obj.type }} ¬∑ {{ obj.deployment_type }}</td>
                <td>{{ obj.responsible }}</td>
                <td>{{ obj.status.documentation }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% endif %}
    </fieldset>
  {% else %}
    <p style="color: #999;">
      Selecione um grupo ativo para come√ßar a edi√ß√£o.
    </p>
  {% endif %}

  <button type="submit">Salvar Projeto</button>
</form>

<!-- Injetar dados do projeto para reidrata√ß√£o -->
<div id="existing-project-data" style="display: none;">
  {{ project | tojson | safe }}
</div>

<script src="{{ url_for('static', filename='js/schema-engine.js') }}"></script>
<script src="{{ url_for('static', filename='js/app.js') }}"></script>

</body>
</html>