<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>OmniDeck ‚Äî Projeto de Migra√ß√£o</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; }
    fieldset { margin-bottom: 24px; padding: 16px; border: 1px solid #ccc; }
    legend { font-weight: bold; }
    label { display: block; margin-top: 8px; }
    input, select, textarea { width: 100%; max-width: 400px; }
    
    /* Valida√ß√£o Leve Schema-Driven (Ajuste 9.3) */
    .field-error {
      border: 2px solid #e53935 !important;
      background-color: #ffebee;
    }
    
    .field-warning {
      border: 2px solid #fb8c00 !important;
      background-color: #fff3e0;
    }
  </style>
</head>
<body>

<h1>OmniDeck</h1>
{% set change_history = project.project_metadata.change_history if project and project.project_metadata else [] %}
<script>
  window.initialChangeHistory = {{ change_history | tojson | safe }};
</script>

<!-- Exibi√ß√£o de Erros de Valida√ß√£o -->
{% if errors %}
  <div style="background-color: #ffebee; border: 2px solid #c62828; color: #b71c1c; padding: 16px; border-radius: 4px; margin-bottom: 24px;">
    <h3 style="margin-top: 0; color: #b71c1c;">‚ö†Ô∏è Erros de Valida√ß√£o</h3>
    <ul style="margin: 0; padding-left: 20px;">
      {% for error in errors %}
        <li>{{ error }}</li>
      {% endfor %}
    </ul>
    <p style="font-size: 12px; margin-bottom: 0; color: #666;">
      Corrija os erros abaixo e tente novamente.
    </p>
  </div>
{% endif %}

<form method="POST">

  <!-- ========================================================================= -->
  <!-- Contexto: Determinar current_object para preencher seletor object_type -->
  <!-- ========================================================================= -->
  {% if project and project.active_group_id %}
    {% set active_id = project.active_group_id %}
    
    <!-- Encontrar o grupo completo do projeto -->
    {% set current_group_ctx = namespace(data=none) %}
    {% if project.groups %}
      {% for g in project.groups %}
        {% if g.group_id == active_id %}
          {% set current_group_ctx.data = g %}
        {% endif %}
      {% endfor %}
    {% endif %}

    <!-- Pegar o √≠ndice do objeto a editar -->
    {% set last_edit_index = project.state.get('last_edit_object_index') if project and project.state else none %}
    {% set edit_object_index = last_edit_index | int if last_edit_index is not none else -1 %}
    
    <!-- Pegar o objeto a editar (se √≠ndice v√°lido) -->
    {% set current_object = none %}
    {% if edit_object_index >= 0 and current_group_ctx.data and edit_object_index < current_group_ctx.data.objects | length %}
      {% set current_object = current_group_ctx.data.objects[edit_object_index] %}
    {% endif %}
  {% else %}
    {% set current_object = none %}
  {% endif %}

  <!-- ========================= -->
  <!-- Identifica√ß√£o do Projeto -->
  <!-- ========================= -->
  <fieldset>
    <legend>{{ ui.project.section }}</legend>

    {% for field, cfg in ui.project.fields.items() %}
      <label>{{ cfg.label }}</label>

      {% if field == "environment.source" %}
        <input
          type="text"
          name="environment.source"
          value="{{ project.project.environment.source if project and project.project and project.project.environment else '' }}"
        >

      {% elif field == "environment.target" %}
        <input
          type="text"
          name="environment.target"
          value="{{ project.project.environment.target if project and project.project and project.project.environment else '' }}"
        >

      {% elif cfg.type == "number" %}
        <input
          type="number"
          name="{{ field }}"
          value="{{ project.project[field] if project and project.project else '' }}"
        >

      {% else %}
        <input
          type="text"
          name="{{ field }}"
          value="{{ project.project[field] if project and project.project else '' }}"
        >
      {% endif %}
    {% endfor %}

    <label style="display: block; margin-top: 12px;"><strong>Status Geral do Projeto</strong></label>
    <select name="overall_status" required>
      <option value="">‚Äî Selecione ‚Äî</option>
      <option value="PENDING" {% if project and project.state and project.state.overall_status == 'PENDING' %}selected{% endif %}>Pendente</option>
      <option value="IN_PROGRESS" {% if project and project.state and project.state.overall_status == 'IN_PROGRESS' %}selected{% endif %}>Em andamento</option>
      <option value="DONE" {% if project and project.state and project.state.overall_status == 'DONE' %}selected{% endif %}>Conclu√≠do</option>
    </select>
  </fieldset>

  {% set objective_meta = project.project_metadata.migration_objective if project and project.project_metadata else {} %}
  {% set objective_content = objective_meta.content if objective_meta.content else [] %}
  {% set objective_title = objective_meta.title if objective_meta.title else "Objetivo do Projeto de Migra√ß√£o" %}

  <fieldset>
    <legend>Cap√≠tulo 0 ‚Äî Objetivo do Projeto de Migra√ß√£o</legend>
    <p style="margin-bottom: 8px; font-size: 13px; color: #555;">
      Edite o texto deste cap√≠tulo. Use linhas que comecem com <code>- </code> para itens de lista.
    </p>
    <textarea
      name="migration_objective_content"
      rows="6"
      style="width: 100%; padding: 8px; font-size: 13px; min-height: 120px;"
    >{{ objective_content | join('\n') }}</textarea>
    <input type="hidden" name="migration_objective_title" value="{{ objective_title }}">
  </fieldset>

  {% set version_control = project.project_metadata.version_control if project and project.project_metadata else {} %}
  <fieldset>
    <legend>Controle de Vers√£o</legend>
    <label>Vers√£o Atual</label>
    <input type="text" name="version_control.current_version" value="{{ version_control.current_version or '' }}">

    <label style="margin-top: 8px;">√öltima Atualiza√ß√£o</label>
    <input type="text" name="version_control.last_update" value="{{ version_control.last_update or '' }}">

    <label style="margin-top: 8px;">Autor</label>
    <input type="text" name="version_control.author" value="{{ version_control.author or '' }}">
  </fieldset>

  {% set change_history = project.project_metadata.change_history if project and project.project_metadata else [] %}
  <fieldset>
    <legend>Hist√≥rico de Altera√ß√µes</legend>
    <div id="change-history-rows"></div>
    <button type="button" onclick="addChangeHistoryRow()" style="margin-top: 8px;">‚ûï Adicionar linha</button>
  </fieldset>

  <!-- ================= -->
  <!-- Grupos Din√¢micos -->
  <!-- ================= -->
  <fieldset>
    <legend>Grupos do Projeto</legend>

    <div id="groups-container"></div>

    <button type="button" onclick="addGroup()">‚ûï Adicionar Grupo</button>
  </fieldset>

  <!-- ================================== -->
  <!-- Seletor de Tipo de Objeto (Global) -->
  <!-- ================================== -->
  <fieldset id="object-type-container" style="display: none;">
    <legend>Tipo do Objeto</legend>
    
    <label>Selecione o tipo (Tabela OTM ou Tipo L√≥gico):</label>
    <select
      name="object_type"
      id="object_type"
      class="form-control object-type-selector"
      {% if current_object and current_object.object_type %}
        data-current-type="{{ current_object.object_type }}"
      {% endif %}
    >
      <!-- Op√ß√µes ser√£o injetadas por schema-engine.js -->
    </select>
  </fieldset>

  <!-- ================================== -->
  <!-- Painel Condicional - Grupo Ativo -->
  <!-- ================================== -->
  {% if project and project.active_group_id %}
    {% set active_id = project.active_group_id %}
    {% set active_group = groups_catalog.get(active_id) %}

    <!-- Encontrar o grupo completo do projeto e √≠ndice -->
    {% set current_group = namespace(data=none) %}
    {% set active_group_index = namespace(value=none) %}
    {% if project.groups %}
      {% for g in project.groups %}
        {% if g.group_id == active_id %}
          {% set current_group.data = g %}
          {% set active_group_index.value = loop.index0 %}
        {% endif %}
      {% endfor %}
    {% endif %}

    <!-- Calcular √≠ndice do formul√°rio (para novo objeto ou edi√ß√£o) -->
    {% set last_edit_index = project.state.get('last_edit_object_index') if project and project.state else none %}
    {% set edit_object_index = last_edit_index | int if last_edit_index is not none else -1 %}
    {% set object_form_index = edit_object_index if edit_object_index >= 0 else (current_group.data.objects | length if current_group.data and current_group.data.objects else 0) %}

    <fieldset style="border: 2px solid #4CAF50;">
      <legend>
        Grupo Ativo ‚Äî {{ active_group.label }}
      </legend>

      <p style="font-size: 13px; color: #555;">
        Voc√™ est√° editando o grupo
        <strong>{{ active_group.label }}</strong>
        ({{ active_group.sequence }}¬∫ no fluxo).
      </p>

      <!-- Descri√ß√£o do Grupo -->
      {% if current_group.data %}
        <input type="hidden" name="groups[{{ active_group_index.value }}][group_id]" value="{{ current_group.data.group_id }}">
        <input type="hidden" name="groups[{{ active_group_index.value }}][label]" value="{{ current_group.data.label }}">
        <input type="hidden" name="groups[{{ active_group_index.value }}][sequence]" value="{{ current_group.data.sequence }}">
        <label style="display:block; font-weight: bold; margin-top: 12px;">Descri√ß√£o do Grupo</label>
        <textarea
          name="groups[{{ active_group_index.value }}][description]"
          rows="3"
          style="width: 100%; max-width: 700px; padding: 8px; font-family: Arial, sans-serif;"
        >{{ current_group.data.description }}</textarea>
      {% endif %}

      <!-- Se√ß√£o de Sele√ß√£o/Cria√ß√£o de Objeto -->
      {% if current_group.data and current_group.data.objects %}
        <label for="edit_object_index" style="font-weight: bold; margin-top: 16px;">Editar Objeto Existente</label>
        <input type="hidden" name="action" value="" id="form_action">
        <select id="edit_object_index" name="edit_object_index" style="margin-bottom: 16px;" onchange="document.getElementById('form_action').value='load_object'; this.form.submit();">
          <option value="">‚Äî Criar novo objeto ‚Äî</option>

          {% for obj in current_group.data.objects %}
            <option value="{{ loop.index0 }}"
              {% if edit_object_index == loop.index0 %}selected{% endif %}
            >
              {{ obj.name or ("Objeto " ~ loop.index) }} ‚Äî {{ obj.object_type or obj.type }} ¬∑ {{ obj.deployment_type }}
            </option>
          {% endfor %}
        </select>
      {% endif %}

      <h4>{% if edit_object_index >= 0 %}Editar Objeto{% else %}Novo Objeto{% endif %}</h4>

      <p style="font-size: 12px; color: #666; margin-bottom: 12px;">
        {% if edit_object_index >= 0 %}
          <strong>Modo: Edi√ß√£o</strong> - Alterando objeto #{{ edit_object_index + 1 }}
        {% else %}
          <strong>Modo: Cria√ß√£o</strong> - Um novo objeto ser√° adicionado ao grupo
        {% endif %}
      </p>

      <!-- Formul√°rio de Objeto -->
      <h4>Dados do Objeto</h4>

      <label><strong>Nome do Objeto *</strong></label>
      <input 
        type="text" 
        name="object_name" 
        required 
        placeholder="Ex: Query de Elegibilidade de Frete"
        value="{{ current_object.name if current_object else '' }}"
      >

      <label>Descri√ß√£o Funcional</label>
      <textarea 
        name="object_description" 
        rows="3" 
        placeholder="Explique o prop√≥sito funcional deste objeto no projeto"
        style="width: 100%; padding: 6px; font-family: Arial, sans-serif; font-size: 12px; border: 1px solid #ccc; border-radius: 3px;"
      >{{ current_object.description if current_object else '' }}</textarea>

      <!-- ========================================== -->
      <!-- SAVED QUERY (somente para tipo SAVED_QUERY) -->
      <!-- ========================================== -->
      <div id="saved_query_block" style="display: none; margin-bottom: 16px;">
        <label><strong>Saved Query (SQL) *</strong></label>
        <textarea 
          name="saved_query_sql" 
          id="saved_query_sql"
          rows="8" 
          placeholder="Digite o SQL da saved query aqui..."
          style="width: 100%; padding: 8px; font-family: 'Courier New', monospace; font-size: 12px; border: 1px solid #ccc; border-radius: 3px; background: #f9f9f9;"
        >{{ current_object.saved_query.sql if current_object and current_object.saved_query else '' }}</textarea>
      </div>

      <!-- ========================================== -->
      <!-- STATUS (sempre vis√≠vel)                  -->
      <!-- ========================================== -->
      <h4 style="margin-top: 16px;">Status</h4>
      
      <label>üìù Documenta√ß√£o</label>
      <select name="status_documentation">
        {% for opt_key, opt_label in enums.status.items() %}
          <option value="{{ opt_key }}" 
            {% if current_object and current_object.status and current_object.status.documentation == opt_key %}selected{% endif %}>
            {{ opt_label }}
          </option>
        {% endfor %}
      </select>

      <label>üì¶ Migration Project</label>
      <select name="status_migration_project">
        {% for opt_key, opt_label in enums.status.items() %}
          <option value="{{ opt_key }}" 
            {% if current_object and current_object.status and current_object.status.migration_project == opt_key %}selected{% endif %}>
            {{ opt_label }}
          </option>
        {% endfor %}
      </select>

      <label>üíæ Exporta√ß√£o</label>
      <select name="status_export">
        {% for opt_key, opt_label in enums.status.items() %}
          <option value="{{ opt_key }}" 
            {% if current_object and current_object.status and current_object.status.export == opt_key %}selected{% endif %}>
            {{ opt_label }}
          </option>
        {% endfor %}
      </select>

      <label>üöÄ Deploy</label>
      <select name="status_deploy">
        {% for opt_key, opt_label in enums.status.items() %}
          <option value="{{ opt_key }}" 
            {% if current_object and current_object.status and current_object.status.deploy == opt_key %}selected{% endif %}>
            {{ opt_label }}
          </option>
        {% endfor %}
      </select>

      <label>‚úÖ Valida√ß√£o</label>
      <select name="status_validation">
        {% for opt_key, opt_label in enums.status.items() %}
          <option value="{{ opt_key }}" 
            {% if current_object and current_object.status and current_object.status.validation == opt_key %}selected{% endif %}>
            {{ opt_label }}
          </option>
        {% endfor %}
      </select>

      <label>Tipo de Deploy</label>
      <select name="object_deployment_type">
        {% for opt in enums.deployment_type %}
          <option value="{{ opt }}" {% if current_object and current_object.deployment_type == opt %}selected{% endif %}>
            {{ opt }}
          </option>
        {% endfor %}
      </select>

      <label>Respons√°vel</label>
      <input type="text" name="object_responsible" value="{{ current_object.responsible if current_object else '' }}">

      <!-- ========================================== -->
      <!-- Identificadores para Tipos L√≥gicos       -->
      <!-- ========================================== -->
      <h4 style="margin-top: 24px;">Identificadores (Tipos L√≥gicos)</h4>

      <!-- SAVED_QUERY -->
      <div id="identifier_query_name" style="display:none;">
        <label>Query Name</label>
        <input type="text" name="identifiers[query_name]" placeholder="Nome da query" value="">
      </div>

      <!-- AGENT -->
      <div id="identifier_agent_gid" style="display:none;">
        <label>Agent GID</label>
        <input type="text" name="identifiers[agent_gid]" placeholder="Identificador do agente" value="">
      </div>

      <!-- FINDER_SET -->
      <div id="identifier_finder_set_gid" style="display:none;">
        <label>Finder Set GID</label>
        <input type="text" name="identifiers[finder_set_gid]" placeholder="Identificador do Finder Set" value="">
      </div>

      <!-- RATE -->
      <div id="identifier_rate_offering_gid" style="display:none;">
        <label>Rate Offering GID</label>
        <input type="text" name="identifiers[rate_offering_gid]" placeholder="Identificador da taxa de oferta" value="">
      </div>

      <!-- EVENT_GROUP -->
      <div id="identifier_event_group_gid" style="display:none;">
        <label>Event Group GID</label>
        <input type="text" name="identifiers[event_group_gid]" placeholder="Identificador do grupo de eventos" value="">
      </div>

      <!-- ========================================== -->
      <!-- Campos Schema-Driven (Tabelas OTM)       -->
      <!-- ========================================== -->
      <div id="schema-sections-container" style="display: none;">
        <!-- Ser√° preenchido dinamicamente por schema-engine.js -->
      </div>

      <!-- ========================================== -->
      <!-- Query de Extra√ß√£o (technical_content)     -->
      <!-- ========================================== -->
      <fieldset style="background-color: #f5f5f5; border: 1px solid #2196F3;">
        <legend style="color: #1976D2;">üîç Query de Extra√ß√£o</legend>
        
        <label><strong>Tipo de Conte√∫do:</strong></label>
        <select name="technical_content_type" style="max-width: 200px; background-color: #e3f2fd; border: 1px solid #64b5f6;">
          <option value="NONE" {% if not current_object or not current_object.technical_content or current_object.technical_content.type == 'NONE' %}selected{% endif %}>Nenhum</option>
          <option value="SQL" {% if current_object and current_object.technical_content and current_object.technical_content.type == 'SQL' %}selected{% endif %}>SQL Query</option>
          <option value="TEXT" {% if current_object and current_object.technical_content and current_object.technical_content.type == 'TEXT' %}selected{% endif %}>Texto T√©cnico</option>
          <option value="SCRIPT" {% if current_object and current_object.technical_content and current_object.technical_content.type == 'SCRIPT' %}selected{% endif %}>Script</option>
          <option value="RULE" {% if current_object and current_object.technical_content and current_object.technical_content.type == 'RULE' %}selected{% endif %}>Regra</option>
        </select>
        
        <label style="margin-top: 12px;"><strong>Conte√∫do (SQL / Script / Texto):</strong></label>
        <textarea
          name="technical_content_content"
          rows="12"
          placeholder="Cole aqui a query SQL, script ou texto t√©cnico..."
          style="font-family: 'Courier New', monospace; font-size: 12px; background-color: #263238; color: #aed581; padding: 12px; border: 1px solid #37474f; width: 100%; max-width: 100%;"
        >{{ current_object.technical_content.content if current_object and current_object.technical_content else '' }}</textarea>
        
        <p style="font-size: 11px; color: #666; margin-top: 8px;">
          üí° Esta query/script √© usada para extrair dados do ambiente de origem ou descrever l√≥gica t√©cnica.
        </p>
      </fieldset>

      <label>Observa√ß√µes T√©cnicas</label>
      <textarea name="object_notes" rows="3">{{ current_object.notes if current_object else '' }}</textarea>

      <!-- Hidden field para manter active_group_id no POST -->
      <input type="hidden" name="active_group_id" value="{{ project.active_group_id if project else '' }}">
      <input type="hidden" name="active_group_index" value="{{ active_group_index.value if active_group_index.value is not none else '' }}">

      <!-- Hidden field para manter edit_object_index no POST -->
      <input type="hidden" name="edit_object_index" value="{{ edit_object_index if edit_object_index >= 0 else '' }}">

      <!-- Se√ß√£o de A√ß√µes do Objeto -->
      {% if edit_object_index >= 0 %}
        <div style="margin-top: 24px; padding: 16px; background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 4px;">
          <p style="font-size: 12px; color: #856404; margin: 0 0 12px 0;">
            <strong>A√ß√µes Dispon√≠veis:</strong>
          </p>

          <!-- Bot√£o Remover (formul√°rio separado) -->
          <form method="POST" style="display: inline;">
            <input type="hidden" name="remove_object_index" value="{{ edit_object_index }}">
            <button type="submit" style="background-color: #e53935; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
              üóëÔ∏è Remover Objeto
            </button>
          </form>

          <p style="font-size: 11px; color: #856404; margin-top: 8px;">
            ‚ö†Ô∏è Esta a√ß√£o remove permanentemente o objeto do grupo.
          </p>
        </div>
      {% endif %}>

      <!-- Lista de Objetos do Grupo Ativo -->
      {% if current_group.data and current_group.data.objects %}
        <h4 style="margin-top: 24px;">Objetos do Grupo</h4>

        <table border="1" cellpadding="6" cellspacing="0" style="border-collapse: collapse; width: 100%; max-width: 900px;">
          <thead>
            <tr style="background-color: #f5f5f5;">
              <th>#</th>
              <th>Nome Funcional</th>
              <th>Tipo ¬∑ Deploy</th>
              <th>Respons√°vel</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% for obj in current_group.data.objects %}
              <tr>
                <td>{{ loop.index }}</td>
                <td><strong>{{ obj.name or "Sem nome" }}</strong></td>
                <td>{{ obj.object_type or obj.type }} ¬∑ {{ obj.deployment_type }}</td>
                <td>{{ obj.responsible }}</td>
                <td>{{ obj.status.documentation }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% endif %}
    </fieldset>
  {% else %}
    <p style="color: #999;">
      Selecione um grupo ativo para come√ßar a edi√ß√£o.
    </p>
  {% endif %}

  <button type="submit">Salvar Projeto</button>
</form>

<!-- Injetar dados do projeto para reidrata√ß√£o -->
<div id="existing-project-data" style="display: none;">
  {{ project | tojson | safe }}
</div>

<script src="{{ url_for('static', filename='js/schema-engine.js') }}"></script>
<script src="{{ url_for('static', filename='js/app.js') }}"></script>

<!-- Injeta dados do objeto existente para SchemaEngine -->
<script>
  // Disponibilizar dados de edi√ß√£o para SchemaEngine
  {% if current_object and current_object.data %}
    window.ExistingObjectData = {{ current_object.data | tojson | safe }};
  {% else %}
    window.ExistingObjectData = {};
  {% endif %}
  
  // Log para debug
  console.log("[Template] Dados do objeto existente:", window.ExistingObjectData);
</script>

</body>
</html>
