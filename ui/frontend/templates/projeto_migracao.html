<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>OmniDeck ‚Äî Projeto de Migra√ß√£o</title>
  <style>
    /* ============================================================
       OmniDeck Design System ‚Äî Professional Corporate Theme v3
       Incorpora tokens Tailwind + estilos CSS prim√°rios
    ============================================================ */
    
    :root {
      /* Core Brand Colors - HSL Values (Tailwind Compatible) */
      --background: 0 0% 97%;
      --foreground: 210 24% 16%;
      --card: 0 0% 100%;
      --card-foreground: 210 24% 16%;
      
      /* Primary - Deep Blue */
      --primary: 210 34% 22%;
      --primary-foreground: 210 40% 98%;
      --primary-600: 210 92% 48%;
      --primary-700: 210 90% 45%;
      
      /* Secondary - Slate */
      --secondary: 210 16% 93%;
      --secondary-foreground: 210 24% 16%;
      
      /* Muted */
      --muted: 210 16% 93%;
      --muted-foreground: 210 12% 45%;
      
      /* Status Colors */
      --success: 142 71% 45%;
      --success-bg: 142 60% 97%;
      --warning: 36 100% 50%;
      --warning-bg: 36 100% 97%;
      --danger: 0 72% 51%;
      --danger-bg: 0 84% 97%;
      --info: 199 89% 48%;
      --info-bg: 199 89% 97%;
      
      /* Borders & Input */
      --border: 210 16% 87%;
      --input: 210 16% 87%;
      --ring: 210 34% 22%;
      
      /* Spacing System */
      --radius: 0.5rem;
      --space-1: 0.375rem;
      --space-2: 0.625rem;
      --space-3: 0.875rem;
      --space-4: 1.25rem;
      --space-5: 1.75rem;
      --space-6: 2.25rem;
      
      /* Shadow System */
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      --shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
      --active-group: hsl(var(--success));
      --active-group-bg: hsl(var(--success-bg));

      /* OmniDeck Suite Identity */
      --omni-app-bg: #0b1220;
      --omni-doc-bg: #f1f5f9;
      --omni-box-bg: #e9eef5;
      --omni-blue: #0b5cff;
      --omni-blue-deep: #0a1e3f;
      --omni-text: #0f1f36;
      --omni-border: #c5d2e4;
    }

    /* Dark Mode Support */
    body.dark {
      --background: 210 24% 9%;
      --foreground: 210 16% 93%;
      --card: 210 24% 12%;
      --card-foreground: 210 16% 93%;
      --primary: 199 89% 48%;
      --secondary: 210 20% 18%;
      --muted: 210 20% 18%;
      --muted-foreground: 210 12% 55%;
      --border: 210 20% 22%;
      --input: 210 20% 22%;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      scroll-behavior: smooth;
      background: var(--omni-app-bg);
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      background: var(--omni-app-bg);
      color: var(--omni-text);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      min-height: 100vh;
      padding-bottom: var(--space-6);
    }

    h1, h2, h3, h4, h5, h6 {
      font-weight: 600;
      letter-spacing: -0.3px;
      line-height: 1.2;
    }

    h1 {
      font-size: clamp(28px, 5vw, 36px);
      color: hsl(var(--primary));
      margin-bottom: var(--space-5);
      font-weight: 700;
    }

    h4 {
      font-size: 16px;
      margin-top: var(--space-5);
      margin-bottom: var(--space-3);
      color: hsl(var(--foreground));
    }

    p {
      color: hsl(var(--muted-foreground));
      line-height: 1.65;
    }

    form {
      width: calc(100vw - 24px);
      max-width: 1680px;
      margin: var(--space-4) auto var(--space-6);
      padding: clamp(14px, 1.6vw, 26px);
      background: var(--omni-doc-bg);
      border: 1px solid var(--omni-border);
      border-radius: 14px;
      box-shadow: 0 20px 48px rgba(10, 30, 63, 0.35);
    }

    /* ================================================
       Card / Fieldset Styling - OmniDeck Base
    ================================================ */
    fieldset {
      margin-bottom: var(--space-5);
      padding: var(--space-5);
      border: 1px solid var(--omni-border);
      border-left: 4px solid var(--omni-blue);
      border-radius: var(--radius);
      background: var(--omni-box-bg);
      box-shadow: var(--shadow-sm);
      transition: box-shadow 0.2s ease, border-color 0.2s ease;
    }

    fieldset:hover {
      box-shadow: var(--shadow-md);
    }

    /* Active Group Card - Special Styling */
    fieldset[style*="border: 2px solid #4CAF50"] {
      border: 2px solid var(--omni-blue) !important;
      background: var(--omni-box-bg) !important;
      box-shadow: 0 8px 24px -8px rgba(11, 92, 255, 0.35);
    }

    legend {
      font-weight: 700;
      padding: 0 var(--space-2);
      color: var(--omni-blue-deep);
      font-size: 16px;
      text-transform: none;
    }

    /* ================================================
       Form Elements
    ================================================ */
    label {
      display: block;
      margin-top: var(--space-3);
      font-weight: 500;
      font-size: 13px;
      color: hsl(var(--foreground));
      transition: color 0.2s ease;
    }

    label:focus-within {
      color: hsl(var(--primary-600));
    }

    input, select, textarea {
      width: 100%;
      max-width: 600px;
      padding: 0.75rem 0.875rem;
      border: 1px solid #b7c6dc;
      border-radius: 8px;
      background: #ffffff;
      color: var(--omni-blue-deep);
      font-size: 14px;
      font-family: inherit;
      line-height: 1.4;
      transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
      outline: none;
    }

    input:hover:not(:disabled), 
    select:hover:not(:disabled), 
    textarea:hover:not(:disabled) {
      border-color: hsl(var(--muted-foreground) / 0.5);
    }

    input:focus, 
    select:focus, 
    textarea:focus {
      border-color: var(--omni-blue);
      box-shadow: 0 0 0 3px rgba(11, 92, 255, 0.2);
      background-color: #ffffff;
    }

    input:disabled, 
    select:disabled, 
    textarea:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    textarea {
      max-width: 100%;
      resize: vertical;
      line-height: 1.55;
      min-height: 90px;
      font-family: 'Fira Code', 'Courier New', monospace;
    }

    input[type="number"] {
      max-width: 200px;
    }

    select {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 0.5rem center;
      background-repeat: no-repeat;
      background-size: 1.5em 1.5em;
      padding-right: 2.5rem;
    }

    /* ================================================
       Buttons & CTAs
    ================================================ */
    button, input[type="submit"] {
      background: hsl(var(--primary-600));
      color: hsl(var(--primary-foreground));
      border: none;
      padding: 0.75rem 1.125rem;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease, background-color 0.15s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    button:hover, input[type="submit"]:hover {
      background: hsl(var(--primary-700));
      box-shadow: 0 10px 22px hsl(var(--primary-600) / 0.2);
      transform: translateY(-1px);
    }

    button:active, input[type="submit"]:active {
      transform: translateY(0);
    }

    button:disabled, input[type="submit"]:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* ================================================
       Tables
    ================================================ */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: var(--space-2);
      background: #ffffff;
      border: 1px solid var(--omni-border);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }

    thead {
      background: var(--omni-blue-deep);
    }

    th {
      padding: 0.75rem 0.875rem;
      border-bottom: 1px solid #26446c;
      text-align: left;
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #ffffff;
    }

    td {
      padding: 0.75rem 0.875rem;
      border-bottom: 1px solid #d8e1ee;
      text-align: left;
      vertical-align: top;
      background: #ffffff;
    }

    tbody tr {
      transition: background-color 0.2s ease;
    }

    tbody tr:nth-child(even) {
      background: #ffffff;
    }

    tbody tr:hover {
      background: #f7fbff;
    }

    /* ================================================
       Tabelas do Painel - Ajuste de Largura
    ================================================ */
    .group-summary-table,
    .group-objects-table {
      width: 100%;
      table-layout: fixed;
    }
    .group-objects-table {
      table-layout: auto;
    }
    .group-objects-table thead th {
      text-align: center !important;
    }

    .group-summary-table th,
    .group-summary-table td,
    .group-objects-table th,
    .group-objects-table td {
      padding: 6px 6px !important;
      vertical-align: middle;
    }

    .group-summary-table th:nth-child(1) { width: 5% !important; }
    .group-summary-table th:nth-child(2) { width: 20% !important; }
    .group-summary-table th:nth-child(3) { width: 54% !important; }
    .group-summary-table th:nth-child(4) { width: 6% !important; }
    .group-summary-table th:nth-child(5) { width: 7% !important; }
    .group-summary-table th:nth-child(6) { width: 8% !important; }
    
    .group-summary-table td:nth-child(1) { width: 5% !important; }
    .group-summary-table td:nth-child(2) { width: 20% !important; }
    .group-summary-table td:nth-child(3) { width: 54% !important; }
    .group-summary-table td:nth-child(4) { width: 6% !important; }
    .group-summary-table td:nth-child(5) { width: 7% !important; }
    .group-summary-table td:nth-child(6) { width: 8% !important; }

    .group-summary-table td:nth-child(2),
    .group-summary-table td:nth-child(3) {
      overflow-wrap: anywhere;
      word-break: break-word;
    }

    .group-objects-table th:nth-child(1) { width: 4% !important; text-align: center !important; }
    .group-objects-table th:nth-child(2) { width: 18% !important; }
    .group-objects-table th:nth-child(3) { width: 26% !important; }
    .group-objects-table th:nth-child(4) { width: 12% !important; }
    .group-objects-table th:nth-child(5) {
      width: 1% !important;
      white-space: nowrap !important;
    }
    .group-objects-table th:nth-child(6) { width: 9% !important; }
    .group-objects-table th:nth-child(7) {
      width: 9% !important;
      text-align: center !important;
      padding-left: 14px !important;
      padding-right: 14px !important;
    }
    .group-objects-table th:nth-child(8),
    .group-objects-table th:nth-child(9),
    .group-objects-table th:nth-child(10),
    .group-objects-table th:nth-child(11),
    .group-objects-table th:nth-child(12) {
      width: 60px !important;
      min-width: 60px !important;
      max-width: 60px !important;
      padding-left: 12px !important;
      padding-right: 12px !important;
      text-align: center !important;
      white-space: nowrap !important;
    }
    .group-objects-table th:nth-child(13) {
      width: 90px !important;
      text-align: center !important;
    }

    .group-objects-table td:nth-child(1) { width: 4% !important; text-align: center !important; }
    .group-objects-table td:nth-child(2) { width: 18% !important; }
    .group-objects-table td:nth-child(3) { width: 26% !important; }
    .group-objects-table td:nth-child(4) { width: 12% !important; }
    .group-objects-table td:nth-child(5) {
      width: 1% !important;
      white-space: nowrap !important;
    }
    .group-objects-table td:nth-child(6) { width: 9% !important; }
    .group-objects-table td:nth-child(7) {
      width: 9% !important;
      text-align: center !important;
      padding-left: 14px !important;
      padding-right: 14px !important;
      white-space: normal !important;
      overflow-wrap: anywhere;
      word-break: break-word;
    }
    .group-objects-table td:nth-child(8),
    .group-objects-table td:nth-child(9),
    .group-objects-table td:nth-child(10),
    .group-objects-table td:nth-child(11),
    .group-objects-table td:nth-child(12) {
      width: 60px !important;
      min-width: 60px !important;
      max-width: 60px !important;
      padding-left: 12px !important;
      padding-right: 12px !important;
      text-align: center !important;
      white-space: nowrap;
    }
    .group-objects-table td:nth-child(13) {
      text-align: center !important;
      white-space: nowrap;
    }
    .group-objects-table td:nth-child(2),
    .group-objects-table td:nth-child(3) {
      white-space: normal !important;
      overflow-wrap: anywhere;
      word-break: break-word;
    }
    .group-objects-table td:nth-child(4),
    .group-objects-table td:nth-child(5) {
      white-space: normal !important;
      overflow-wrap: anywhere;
      word-break: break-word;
    }
    .group-objects-table td:nth-child(4) span,
    .group-objects-table td:nth-child(5) span {
      display: inline-block;
      max-width: 100%;
      white-space: normal;
      line-height: 1.25;
    }

    /* ================================================
       Object Editor - Width Safeguards
    ================================================ */
    .object-edit-fieldset,
    #schema-sections-container,
    #schema-sections-container fieldset {
      width: 100%;
      max-width: 100%;
      min-width: 0;
      min-inline-size: 0;
      box-sizing: border-box;
    }

    .object-edit-fieldset {
      overflow-x: hidden;
    }

    .object-edit-grid-2,
    .object-edit-grid-3,
    .object-edit-grid-4,
    .object-edit-grid-5 {
      display: grid;
      gap: 12px;
      width: 100%;
      max-width: 100%;
    }

    .object-edit-grid-2 {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    .object-edit-grid-3 {
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }

    .object-edit-grid-4 {
      grid-template-columns: repeat(4, minmax(0, 1fr));
    }

    .object-edit-grid-5 {
      grid-template-columns: repeat(5, minmax(0, 1fr));
    }

    .object-edit-grid-2 > div,
    .object-edit-grid-3 > div,
    .object-edit-grid-4 > div,
    .object-edit-grid-5 > div {
      min-width: 0;
    }

    .object-edit-fieldset input,
    .object-edit-fieldset select,
    .object-edit-fieldset textarea {
      max-width: 100% !important;
      min-width: 0 !important;
      box-sizing: border-box;
    }

    .object-edit-actions .action-inline-form {
      width: auto !important;
      max-width: none !important;
      margin: 0 !important;
      padding: 0 !important;
      background: transparent !important;
      border: 0 !important;
      border-radius: 0 !important;
      box-shadow: none !important;
    }

    #schema-sections-container input,
    #schema-sections-container select,
    #schema-sections-container textarea {
      max-width: 100% !important;
      min-width: 0 !important;
    }

    .object-edit-fieldset label,
    .object-edit-fieldset p,
    .object-edit-fieldset legend,
    #schema-sections-container label,
    #schema-sections-container p,
    #schema-sections-container legend {
      overflow-wrap: anywhere;
      word-break: break-word;
    }

    @media (max-width: 1024px) {
      .object-edit-grid-5 {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
      .object-edit-grid-4 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .object-edit-grid-3 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 768px) {
      .object-edit-grid-2,
      .object-edit-grid-3,
      .object-edit-grid-4,
      .object-edit-grid-5 {
        grid-template-columns: 1fr;
      }
    }

    /* ================================================
       Field States & Validation
    ================================================ */
    .field-error {
      border: 2px solid hsl(var(--danger)) !important;
      background-color: hsl(var(--danger-bg)) !important;
    }

    .field-warning {
      border: 2px solid hsl(var(--warning)) !important;
      background-color: hsl(var(--warning-bg)) !important;
    }

    .field-success {
      border: 2px solid hsl(var(--success)) !important;
      background-color: hsl(var(--success-bg)) !important;
    }

    /* ================================================
       Alert / Error Messages
    ================================================ */
    .error-alert {
      background: hsl(var(--danger-bg));
      border: 2px solid hsl(var(--danger));
      color: hsl(var(--danger));
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
    }

    .error-alert h3 {
      margin-top: 0;
      color: hsl(var(--danger));
      font-weight: 600;
    }

    .error-alert ul {
      margin: 0;
      padding-left: 1.25rem;
    }

    .error-alert li {
      font-size: 13px;
      line-height: 1.5;
    }

    /* ================================================
       Responsive Grid
    ================================================ */
    @media (max-width: 1024px) {
      form { width: calc(100vw - 16px); padding: var(--space-4); }
      input, select, textarea { max-width: 100%; }
      fieldset { padding: var(--space-4); }
      h1 { font-size: 28px; }
      .group-objects-table,
      .group-summary-table { font-size: 12px; }
      .group-objects-table th,
      .group-objects-table td,
      .group-summary-table th,
      .group-summary-table td { padding: 5px 4px !important; }
    }

    @media (max-width: 768px) {
      form { width: calc(100vw - 12px); padding: var(--space-3); }
      fieldset { padding: var(--space-3); }
      label { font-size: 12px; }
      input, select, textarea { font-size: 16px; }
      button, input[type="submit"] { width: 100%; justify-content: center; }
    }

    @media (max-width: 480px) {
      h1 { font-size: 24px; }
      legend { font-size: 14px; }
      fieldset { margin-bottom: var(--space-4); }
    }

    /* Prefer Reduced Motion */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* ================================================
       Badge Styles - Deployment Types & Status
    ================================================ */
    .badge-deployment {
      padding: 3px 8px;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 500;
      display: inline-block;
    }

    .badge-deployment-novo {
      background-color: #d4edda;
      color: #155724;
    }

    .badge-deployment-alteracao {
      background-color: #fff3cd;
      color: #856404;
    }

    .badge-deployment-default {
      background-color: #e2e3e5;
      color: #383d41;
    }

    .badge-status {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 600;
      display: inline-block;
    }

    .badge-status-done {
      background-color: #28a745;
      color: white;
    }

    .badge-status-in-progress {
      background-color: #ffc107;
      color: #212529;
    }

    .badge-status-not-started {
      background-color: #dc3545;
      color: white;
    }

    .badge-status-default {
      background-color: #6c757d;
      color: white;
    }

    /* ================================================
       Table Row Styling
    ================================================ */
    .table-row-even {
      background-color: #ffffff;
    }

    .table-row-odd {
      background-color: #ffffff;
    }

    .table-row {
      border-bottom: 1px solid #e9ecef;
      transition: background-color 0.2s;
    }

    .panel-brand {
      width: calc(100vw - 24px);
      max-width: 1680px;
      margin: var(--space-4) auto 0;
      padding: 0 clamp(2px, 0.8vw, 10px);
      display: grid;
      grid-template-columns: clamp(120px, 18vw, 220px) minmax(0, 1fr) clamp(120px, 18vw, 220px);
      align-items: center;
      column-gap: 20px;
    }

    .panel-brand::after {
      content: "";
      width: clamp(120px, 18vw, 220px);
      height: 1px;
      visibility: hidden;
    }

    .panel-brand__logo {
      grid-column: 1;
      justify-self: start;
      display: block;
      width: clamp(120px, 18vw, 220px);
      height: auto;
      filter: drop-shadow(0 10px 24px rgba(10, 30, 63, 0.45));
    }

    .panel-brand__content {
      grid-column: 2;
      justify-self: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      gap: 6px;
      width: 100%;
      min-width: 0;
      max-width: none;
    }

    .panel-brand__title {
      margin: 0;
      font-size: clamp(20px, 2.4vw, 34px);
      line-height: 1.1;
      color: #e9eef5;
      font-weight: 700;
      letter-spacing: 0.2px;
      white-space: nowrap !important;
      text-wrap: nowrap !important;
    }

    .panel-brand__subtitle {
      margin: 0;
      font-size: 13px;
      color: #9db0cf;
      font-weight: 500;
    }

    @media (max-width: 768px) {
      .panel-brand {
        display: flex;
        width: calc(100vw - 12px);
        flex-direction: column;
        align-items: center;
        gap: 14px;
        padding: 0;
      }

      .panel-brand::after {
        display: none;
      }

      .panel-brand__logo {
        width: clamp(150px, 52vw, 240px);
      }

      .panel-brand__content {
        text-align: center;
        align-items: center;
      }

      .panel-brand__title {
        font-size: clamp(13px, 3.8vw, 20px);
      }
    }

    /* ============================================================
       OmniDeck Identity Overrides for Inline Styles
       ============================================================ */
    fieldset[style*="background-color"] {
      background: var(--omni-box-bg) !important;
      border-color: var(--omni-border) !important;
    }

    fieldset[style*="border-left"] {
      border-left-color: var(--omni-blue) !important;
    }

    fieldset legend[style*="color"] {
      color: var(--omni-blue-deep) !important;
    }

    input[style],
    select[style],
    textarea[style] {
      background: #ffffff !important;
      border-color: #b7c6dc !important;
      color: var(--omni-blue-deep) !important;
    }

    input[readonly][style] {
      background: #ffffff !important;
      color: #3d4f68 !important;
    }

    table[style],
    table[style] td {
      background: #ffffff !important;
    }

    table[style] thead tr[style] {
      background: var(--omni-blue-deep) !important;
    }

    table[style] thead tr[style] th {
      background: var(--omni-blue-deep) !important;
      color: #ffffff !important;
      border-bottom: 1px solid #26446c !important;
    }

    #change-history-table thead th {
      color: #fff !important;
      font-weight: 700 !important;
      font-size: 12px !important;
      line-height: 1.4 !important;
      /* O background ser√° definido pelo CSS institucional */
    }
    }

    tr[style*="background-color: #f5f5f5"],
    tr[style*="background-color: #f8f9fa"] {
      background-color: #ffffff !important;
    }
  </style>
</head>
<body>

<header class="panel-brand" aria-label="Identidade OmniDeck">
  <img
    class="panel-brand__logo"
    src="{{ url_for('static', filename='img/omnideck_logo.png') }}"
    alt="OmniDeck"
  >
  <div class="panel-brand__content">
    <h1 class="panel-brand__title">Painel de Constru√ß√£o - Projeto de Migra√ß√£o</h1>
    <p class="panel-brand__subtitle">Gest√£o e acompanhamento da migra√ß√£o OTM DEV para OTM PROD</p>
  </div>
</header>
{% set change_history = project.project_metadata.change_history if project and project.project_metadata else [] %}
<script>
  window.initialChangeHistory = {{ change_history | tojson | safe }};
</script>

<!-- Exibi√ß√£o de Erros de Valida√ß√£o -->
{% if errors %}
  <div style="background-color: #ffebee; border: 2px solid #c62828; color: #b71c1c; padding: 16px; border-radius: 4px; margin-bottom: 24px;">
    <h3 style="margin-top: 0; color: #b71c1c;">‚ö†Ô∏è Erros de Valida√ß√£o</h3>
    <ul style="margin: 0; padding-left: 20px;">
      {% for error in errors %}
        <li>{{ error }}</li>
      {% endfor %}
    </ul>
    <p style="font-size: 12px; margin-bottom: 0; color: #666;">
      Corrija os erros abaixo e tente novamente.
    </p>
  </div>
{% endif %}

<form id="project-form" method="POST">

  <!-- ========================================================================= -->
  <!-- Contexto: Determinar current_object para preencher seletor object_type -->
  <!-- ========================================================================= -->
  {% if project and project.active_group_id %}
    {% set active_id = project.active_group_id %}
    
    <!-- Encontrar o grupo completo do projeto -->
    {% set current_group_ctx = namespace(data=none) %}
    {% if project.groups %}
      {% for g in project.groups %}
        {% if g.group_id == active_id %}
          {% set current_group_ctx.data = g %}
        {% endif %}
      {% endfor %}
    {% endif %}

    <!-- Pegar o indice do item em edicao -->
    {% set last_edit_index = project.state.get('last_edit_object_index') if project and project.state else none %}
    {% set edit_object_index = last_edit_index | int if last_edit_index is not none else -1 %}
    
    <!-- Pegar o item em edicao (se indice valido) -->
    {% set current_object = none %}
    {% if edit_object_index >= 0 and current_group_ctx.data and edit_object_index < current_group_ctx.data.objects | length %}
      {% set current_object = current_group_ctx.data.objects[edit_object_index] %}
    {% endif %}
  {% else %}
    {% set current_object = none %}
  {% endif %}

  <!-- ========================= -->
  <!-- Identifica√ß√£o do Projeto -->
  <!-- ========================= -->
  <fieldset>
    <legend>{{ ui.project.section }}</legend>

    {% set env_source = ui.project.fields.get('environment.source') %}
    {% set env_target = ui.project.fields.get('environment.target') %}

    {% set project_code = ui.project.fields.get('code') %}
    {% set project_name = ui.project.fields.get('name') %}
    {% set project_version = ui.project.fields.get('version') %}
    {% set project_consultant = ui.project.fields.get('consultant') %}

    <div style="display: grid; gap: 16px;">
      <div style="display: grid; grid-template-columns: 1.2fr 140px 2.8fr 70px 1.1fr; gap: 16px; align-items: end;">
        <div>
          <label><strong>Status Geral do Projeto</strong></label>
          <select name="overall_status" required>
            <option value="">‚Äî Selecione ‚Äî</option>
            <option value="PENDING" {% if project and project.state and project.state.overall_status == 'PENDING' %}selected{% endif %}>Pendente</option>
            <option value="IN_PROGRESS" {% if project and project.state and project.state.overall_status == 'IN_PROGRESS' %}selected{% endif %}>Em andamento</option>
            <option value="DONE" {% if project and project.state and project.state.overall_status == 'DONE' %}selected{% endif %}>Conclu√≠do</option>
          </select>
        </div>

        <div>
          <label>{{ project_code.label if project_code else 'C√≥digo do Projeto' }}</label>
          <input
            type="text"
            name="code"
            value="{{ project.project.code if project and project.project else '' }}"
            style="max-width: 160px;"
          >
        </div>

        <div>
          <label>{{ project_name.label if project_name else 'Nome do Projeto' }}</label>
          <input
            type="text"
            name="name"
            value="{{ project.project.name if project and project.project else '' }}"
            style="width: 100%;"
          >
        </div>

        <div>
          <label>{{ project_version.label if project_version else 'Vers√£o' }}</label>
          <input
            type="text"
            name="version"
            value="{{ project.project.version if project and project.project else '' }}"
            style="max-width: 70px;"
          >
        </div>

        <div>
          <label>{{ project_consultant.label if project_consultant else 'Consultor' }}</label>
          <input
            type="text"
            name="consultant"
            value="{{ project.project.consultant if project and project.project else '' }}"
          >
        </div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; align-items: end;">
        <div>
          <label>{{ env_source.label if env_source else 'Ambiente Origem' }}</label>
          <input
            type="text"
            name="environment.source"
            value="{{ project.project.environment.source if project and project.project and project.project.environment else '' }}"
          >
        </div>

        <div>
          <label>{{ env_target.label if env_target else 'Ambiente Destino' }}</label>
          <input
            type="text"
            name="environment.target"
            value="{{ project.project.environment.target if project and project.project and project.project.environment else '' }}"
          >
        </div>
      </div>
    </div>
  </fieldset>

  {% set objective_meta = project.project_metadata.migration_objective if project and project.project_metadata else {} %}
  {% set objective_content = objective_meta.content if objective_meta.content else [] %}
  {% set objective_title = objective_meta.title if objective_meta.title else "Objetivo do Projeto de Migra√ß√£o" %}

  <fieldset>
    <legend>Objetivo do Projeto de Migra√ß√£o</legend>
    <p style="margin-bottom: 8px; font-size: 13px; color: #555;">
      Edite o texto deste cap√≠tulo. Use linhas que comecem com <code>- </code> para itens de lista.
    </p>
    <textarea
      name="migration_objective_content"
      rows="6"
      style="width: 100%; padding: 8px; font-size: 13px; min-height: 120px;"
    >{{ objective_content | join('\n') }}</textarea>
    <input type="hidden" name="migration_objective_title" value="{{ objective_title }}">
  </fieldset>

  {% set version_control = project.project_metadata.version_control if project and project.project_metadata else {} %}
  <fieldset>
    <legend>Controle de Vers√£o <span style="font-size: 11px; color: #999; font-weight: normal;">(atualizado automaticamente)</span></legend>
    <div style="display: grid; grid-template-columns: 1fr 2fr 1.5fr; gap: 16px; align-items: end;">
      <div>
        <label>Vers√£o Atual</label>
        <input type="text" id="version_control_current_version" name="version_control.current_version" value="{{ version_control.current_version or '' }}" readonly style="background-color: #f5f5f5; cursor: not-allowed;">
      </div>
      
      <div>
        <label>√öltima Atualiza√ß√£o</label>
        <input type="text" id="version_control_last_update" name="version_control.last_update" value="{{ version_control.last_update or '' }}" readonly style="background-color: #f5f5f5; cursor: not-allowed;">
      </div>
      
      <div>
        <label>Autor</label>
        <input type="text" id="version_control_author" name="version_control.author" value="{{ version_control.author or '' }}" readonly style="background-color: #f5f5f5; cursor: not-allowed;">
      </div>
    </div>
  </fieldset>

  {% set change_history = project.project_metadata.change_history if project and project.project_metadata else [] %}
  <fieldset>
    <legend>Hist√≥rico de Altera√ß√µes</legend>
    <div style="display: flex; justify-content: flex-end; margin-bottom: 10px;">
      <button
        type="button"
        id="toggle-change-history-btn"
        style="background: #374151; color: #fff; border: none; border-radius: 6px; padding: 6px 10px; font-size: 12px; cursor: pointer;"
        aria-controls="change-history-content"
        aria-expanded="true"
      >
        Recolher lista
      </button>
    </div>
    <div id="change-history-content">
    <table id="change-history-table" style="width: 100%; border-collapse: collapse; margin-bottom: 12px;">
      <thead>
        <tr>
          <th class="omni-header-th" style="width: 8%;">Data</th>
          <th class="omni-header-th" style="width: 6%;">Vers√£o</th>
          <th class="omni-header-th" style="width: 64%;">Descri√ß√£o</th>
          <th class="omni-header-th" style="width: 12%;">Autor</th>
          <th class="omni-header-th" style="width: 10%; text-align: center;">A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="change-history-rows">
      </tbody>
    </table>
    </div>
    <button type="button" onclick="addChangeHistoryRow()" style="padding: 6px 12px; font-size: 13px;">‚ûï Adicionar linha</button>
  </fieldset>

  <!-- ======================== -->
  <!-- Grupos de Migracao -->
  <!-- ======================== -->
  <fieldset>
    <legend>Grupos de Migra√ß√£o do Projeto</legend>
    
    <p style="font-size: 13px; color: #555; margin-bottom: 12px;">
      Lista de todos os grupos criados. Para editar os itens, selecione o grupo ativo abaixo.
    </p>
    <div style="display: flex; justify-content: flex-end; margin-bottom: 10px;">
      <button
        type="button"
        id="toggle-project-groups-btn"
        style="background: #374151; color: #fff; border: none; border-radius: 6px; padding: 6px 10px; font-size: 12px; cursor: pointer;"
        aria-controls="project-groups-content"
        aria-expanded="true"
      >
        Recolher lista
      </button>
    </div>

    <div id="project-groups-content">
    {% if project and project.groups %}
      <table class="group-summary-table" style="width: 100%; margin-bottom: 16px; border-collapse: collapse; font-size: 13px;">
        <thead>
          <tr style="background-color: #f5f5f5; border-bottom: 1px solid #ddd;">
            <th style="text-align: center; padding: 6px 8px; font-weight: 600; width: 40px;">#</th>
            <th style="text-align: left; padding: 6px 8px; font-weight: 600; width: 180px;">Nome do Grupo</th>
            <th style="text-align: left; padding: 6px 8px; font-weight: 600; width: 590px; white-space: normal;">Descri√ß√£o</th>
            <th style="text-align: center; padding: 6px 8px; font-weight: 600; width: 42px;">Ordem</th>
            <th style="text-align: center; padding: 6px 8px; font-weight: 600; width: 52px;">Itens</th>
            <th style="text-align: center; padding: 6px 8px; font-weight: 600; width: 78px;">A√ß√µes</th>
          </tr>
        </thead>
        <tbody>
          {% set manual_group_rank = namespace(value=0) %}
          {% for g in project.groups %}
            {% set is_special_group = (g.group_id|string|upper in ['SEM_GRUPO', 'GROUP_0', 'IGNORADOS']) %}
            {% if not is_special_group %}
              {% set manual_group_rank.value = manual_group_rank.value + 1 %}
            {% endif %}
            <tr class="{% if loop.index % 2 == 0 %}table-row-even{% else %}table-row-odd{% endif %}" style="border-bottom: 1px solid #eee;">
              <td style="padding: 2px 8px; text-align: center; color: #666;">
                {{ 0 if is_special_group else manual_group_rank.value }}
              </td>
              <td style="padding: 2px 8px; white-space: nowrap;"><strong>{{ g.label }}</strong></td>
              <td style="padding: 2px 8px; color: #666; white-space: normal;">{{ g.description if g.description is defined else 'Sem descri√ß√£o' }}</td>
              <td style="text-align: center; padding: 2px 8px; color: #666;">{{ g.sequence }}¬∫</td>
              <td style="text-align: center; padding: 2px 8px; color: #666;">{{ g.objects|length if g.objects else 0 }}</td>
              <td class="actions-cell" style="text-align: center;">
                <button type="button" class="icon-btn" onclick="submitProjectAction({'active_group_id': '{{ g.group_id }}', 'reset_edit_mode': '1'})" style="background: #2196F3; color: white; border: none; padding: 3px 6px; border-radius: 3px; cursor: pointer; font-size: 13px; margin: 0 4px 0 0; display: inline-block;" title="Editar grupo">‚úèÔ∏è</button>
                {% if g.group_id|string|upper not in ['SEM_GRUPO', 'GROUP_0', 'IGNORADOS'] %}
                  <button type="button" class="icon-btn" onclick="if(confirm('Tem certeza que deseja remover este grupo?')) submitProjectAction({'remove_group_id': '{{ g.group_id }}'})" style="background: #f44336; color: white; border: none; padding: 3px 6px; border-radius: 3px; cursor: pointer; font-size: 13px; margin: 0; display: inline-block;" title="Remover grupo">üóëÔ∏è</button>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p style="color: #999; font-style: italic;">Nenhum grupo criado ainda.</p>
    {% endif %}
    </div>

    <div id="groups-container"></div>

    <button type="button" onclick="addGroup()">‚ûï Adicionar Grupo</button>
  </fieldset>

  <!-- ================================ -->
  <!-- Descricao do Grupo Ativo -->
  <!-- ================================ -->
  {% if project and project.active_group_id %}
    {% set active_group = groups_catalog.get(project.active_group_id) %}
    {% if active_group %}
      <fieldset style="margin-bottom: 24px; background-color: #f0f8ff; border-left: 4px solid #0066cc;">
        <legend style="color: #0066cc; font-weight: 600;">üìù Descri√ß√£o do Grupo</legend>
        <p style="color: #333; line-height: 1.6; margin: 0;">
          {{ active_group.description or '<span style="color: #999; font-style: italic;">Nenhuma descri√ß√£o fornecida para este grupo.</span>' | safe }}
        </p>
      </fieldset>
    {% endif %}
  {% endif %}

  <!-- ================================= -->
  <!-- Painel Condicional - Grupo Ativo -->
  <!-- ================================= -->
  {% if project and project.active_group_id %}
    {% set active_id = project.active_group_id %}
    {% set active_group = groups_catalog.get(active_id) %}

    <!-- Encontrar o grupo completo do projeto e indice -->
    {% set current_group = namespace(data=none) %}
    {% set active_group_index = namespace(value=none) %}
    {% if project.groups %}
      {% for g in project.groups %}
        {% if g.group_id == active_id %}
          {% set current_group.data = g %}
          {% set active_group_index.value = loop.index0 %}
        {% endif %}
      {% endfor %}
    {% endif %}

    <!-- ======================================= -->
    <!-- Lista de Itens do Grupo (MOVIDA) -->
    <!-- ======================================= -->
    {% if current_group.data and current_group.data.objects %}
      <fieldset style="margin-bottom: 24px;">
        <legend>üì¶ Itens do Grupo ({{ current_group.data.objects|length }})</legend>
        <div style="display: flex; justify-content: flex-end; margin-bottom: 10px;">
          <button
            type="button"
            id="toggle-group-objects-btn"
            style="background: #374151; color: #fff; border: none; border-radius: 6px; padding: 6px 10px; font-size: 12px; cursor: pointer;"
            aria-controls="group-objects-content"
            aria-expanded="true"
          >
            Recolher lista
          </button>
        </div>

        <div id="group-objects-content">
        <table class="group-objects-table" style="border-collapse: collapse; width: 100%; font-size: 13px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
          <thead>
            <tr style="background: linear-gradient(to bottom, #f8f9fa 0%, #e9ecef 100%); border-bottom: 2px solid #dee2e6;">
              <th style="padding: 10px 12px; text-align: center; font-weight: 600; color: #495057; width: 40px;">#</th>
              <th style="padding: 10px 12px; text-align: left; font-weight: 600; color: #495057; width: 176px;">Nome Funcional</th>
              <th style="padding: 10px 12px; text-align: left; font-weight: 600; color: #495057; width: 324px;">Descri√ß√£o Funcional</th>
              <th style="padding: 10px 12px; text-align: left; font-weight: 600; color: #495057; width: 170px;">Tabela OTM</th>
              <th style="padding: 10px 12px; text-align: left; font-weight: 600; color: #495057;">Dominio</th>
              <th style="padding: 10px 12px; text-align: left; font-weight: 600; color: #495057; width: 110px;">Tipo Deploy</th>
              <th style="padding: 10px 14px; text-align: center; font-weight: 600; color: #495057; width: 90px;">Resp.</th>
              <th style="padding: 10px 12px; text-align: center; font-weight: 600; color: #495057; width: 60px;">üìù Doc.</th>
              <th style="padding: 10px 12px; text-align: center; font-weight: 600; color: #495057; width: 60px;">üì¶ Mig.</th>
              <th style="padding: 10px 12px; text-align: center; font-weight: 600; color: #495057; width: 60px;">üíæ Exp.</th>
              <th style="padding: 10px 12px; text-align: center; font-weight: 600; color: #495057; width: 60px;">üöÄ Dep.</th>
              <th style="padding: 10px 12px; text-align: center; font-weight: 600; color: #495057; width: 60px;">‚úÖ Val.</th>
              <th style="padding: 10px 12px; text-align: center; font-weight: 600; color: #495057; width: 90px;">A√ß√µes</th>
            </tr>
          </thead>
          <tbody>
            {% for obj in current_group.data.objects %}
              <tr class="table-row {% if loop.index % 2 == 0 %}table-row-even{% else %}table-row-odd{% endif %}">
                <td style="padding: 10px 12px; text-align: center; color: #6c757d; font-weight: 500;">{{ loop.index }}</td>
                <td style="padding: 10px 12px;">
                  <strong style="color: #212529;">{{ obj.name or "Sem nome" }}</strong>
                </td>
                <td style="padding: 10px 12px; color: #495057;">
                  {% if obj.description %}
                    {{ obj.description }}
                  {% else %}
                    <span style="color: #adb5bd; font-size: 11px;">-</span>
                  {% endif %}
                </td>
                <td style="padding: 10px 12px; color: #495057;">
                  {% set primary_table = obj.otm_table or obj.object_type or obj.type or "N/A" %}
                  {% set subtables = obj.otm_subtables if obj.otm_subtables is iterable and obj.otm_subtables is not string else [] %}
                  <span style="background-color: #e7f3ff; padding: 3px 8px; border-radius: 3px; font-size: 11px; font-weight: 500; color: #0066cc;">
                    {{ primary_table }}
                  </span>
                  {% if subtables %}
                    <div style="margin-top: 4px; font-size: 10px; color: #6b7280; line-height: 1.2;">
                      Subtabelas: {{ subtables | join(", ") }}
                    </div>
                  {% endif %}
                </td>
                <td style="padding: 10px 12px; color: #495057;">
                  {% if obj.domainName or obj.domain %}
                    <span style="background-color: #f3f4f6; padding: 3px 8px; border-radius: 3px; font-size: 11px; font-weight: 500; color: #334155;">
                      {{ obj.domainName or obj.domain }}
                    </span>
                  {% else %}
                    <span style="color: #adb5bd; font-size: 11px;">-</span>
                  {% endif %}
                </td>
                <td style="padding: 10px 12px; color: #495057;">
                  {% if obj.deployment_type %}
                    <span class="badge-deployment {% if obj.deployment_type == 'NOVO' %}badge-deployment-novo{% elif obj.deployment_type == 'ALTERACAO' %}badge-deployment-alteracao{% else %}badge-deployment-default{% endif %}">
                      {{ obj.deployment_type }}
                    </span>
                  {% else %}
                    <span style="color: #adb5bd; font-size: 11px;">-</span>
                  {% endif %}
                </td>
                <td style="padding: 10px 14px; text-align: center; color: #495057;">{{ obj.responsible or "-" }}</td>
                <td style="padding: 10px 12px; text-align: center;">
                  {% if obj.status and obj.status.documentation %}
                    <span class="badge-status {% if obj.status.documentation == 'DONE' %}badge-status-done{% elif obj.status.documentation == 'IN_PROGRESS' %}badge-status-in-progress{% elif obj.status.documentation == 'NOT_STARTED' %}badge-status-not-started{% else %}badge-status-default{% endif %}">
                      {% if obj.status.documentation == 'DONE' %}‚úì
                      {% elif obj.status.documentation == 'IN_PROGRESS' %}‚è≥
                      {% elif obj.status.documentation == 'NOT_STARTED' %}‚óã
                      {% else %}‚óã{% endif %}
                    </span>
                  {% else %}
                    <span style="color: #adb5bd; font-size: 11px;">-</span>
                  {% endif %}
                </td>
                <td style="padding: 10px 12px; text-align: center;">
                  {% if obj.status and obj.status.migration_project %}
                    <span class="badge-status {% if obj.status.migration_project == 'DONE' %}badge-status-done{% elif obj.status.migration_project == 'IN_PROGRESS' %}badge-status-in-progress{% elif obj.status.migration_project == 'NOT_STARTED' %}badge-status-not-started{% else %}badge-status-default{% endif %}">
                      {% if obj.status.migration_project == 'DONE' %}‚úì
                      {% elif obj.status.migration_project == 'IN_PROGRESS' %}‚è≥
                      {% elif obj.status.migration_project == 'NOT_STARTED' %}‚óã
                      {% else %}‚óã{% endif %}
                    </span>
                  {% else %}
                    <span style="color: #adb5bd; font-size: 11px;">-</span>
                  {% endif %}
                </td>
                <td style="padding: 10px 12px; text-align: center;">
                  {% if obj.status and obj.status.export %}
                    <span class="badge-status {% if obj.status.export == 'DONE' %}badge-status-done{% elif obj.status.export == 'IN_PROGRESS' %}badge-status-in-progress{% elif obj.status.export == 'NOT_STARTED' %}badge-status-not-started{% else %}badge-status-default{% endif %}">
                      {% if obj.status.export == 'DONE' %}‚úì
                      {% elif obj.status.export == 'IN_PROGRESS' %}‚è≥
                      {% elif obj.status.export == 'NOT_STARTED' %}‚óã
                      {% else %}‚óã{% endif %}
                    </span>
                  {% else %}
                    <span style="color: #adb5bd; font-size: 11px;">-</span>
                  {% endif %}
                </td>
                <td style="padding: 10px 12px; text-align: center;">
                  {% if obj.status and obj.status.deploy %}
                    <span class="badge-status {% if obj.status.deploy == 'DONE' %}badge-status-done{% elif obj.status.deploy == 'IN_PROGRESS' %}badge-status-in-progress{% elif obj.status.deploy == 'NOT_STARTED' %}badge-status-not-started{% else %}badge-status-default{% endif %}">
                      {% if obj.status.deploy == 'DONE' %}‚úì
                      {% elif obj.status.deploy == 'IN_PROGRESS' %}‚è≥
                      {% elif obj.status.deploy == 'NOT_STARTED' %}‚óã
                      {% else %}‚óã{% endif %}
                    </span>
                  {% else %}
                    <span style="color: #adb5bd; font-size: 11px;">-</span>
                  {% endif %}
                </td>
                <td style="padding: 10px 12px; text-align: center;">
                  {% if obj.status and obj.status.validation %}
                    <span class="badge-status {% if obj.status.validation == 'DONE' %}badge-status-done{% elif obj.status.validation == 'IN_PROGRESS' %}badge-status-in-progress{% elif obj.status.validation == 'NOT_STARTED' %}badge-status-not-started{% else %}badge-status-default{% endif %}">
                      {% if obj.status.validation == 'DONE' %}‚úì
                      {% elif obj.status.validation == 'IN_PROGRESS' %}‚è≥
                      {% elif obj.status.validation == 'NOT_STARTED' %}‚óã
                      {% else %}‚óã{% endif %}
                    </span>
                  {% else %}
                    <span style="color: #adb5bd; font-size: 11px;">-</span>
                  {% endif %}
                </td>
                <td class="actions-cell">
                  <button type="button" class="icon-btn" onclick="submitProjectAction({'action': 'load_object', 'edit_object_index': '{{ loop.index0 }}', 'active_group_id': '{{ active_id }}'})" style="background: #2196F3; color: white; border: none; padding: 3px 6px; border-radius: 3px; cursor: pointer; font-size: 13px; margin: 0 4px 0 0; display: inline-block;" title="Editar item">‚úèÔ∏è</button><button type="button" class="icon-btn" onclick="if(confirm('Tem certeza que deseja remover este item?')) submitProjectAction({'remove_object_index': '{{ loop.index0 }}', 'active_group_id': '{{ active_id }}'})" style="background: #f44336; color: white; border: none; padding: 3px 6px; border-radius: 3px; cursor: pointer; font-size: 13px; margin: 0; display: inline-block;" title="Remover item">üóëÔ∏è</button>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        
        <p style="font-size: 11px; color: #6c757d; margin-top: 12px;">
          üí° Selecione um item na lista para edit√°-lo.
        </p>
        </div>
      </fieldset>
    {% endif %}

    <!-- Retirar a declara√ß√£o repetida de active_group_index e current_group -->
    {% set current_group = namespace(data=none) %}
    {% set active_group_index = namespace(value=none) %}
    {% if project.groups %}
      {% for g in project.groups %}
        {% if g.group_id == active_id %}
          {% set current_group.data = g %}
          {% set active_group_index.value = loop.index0 %}
        {% endif %}
      {% endfor %}
    {% endif %}

    <!-- Calcular indice do formulario (para novo item ou edicao) -->
    {% set last_edit_index = project.state.get('last_edit_object_index') if project and project.state else none %}
    {% set edit_object_index = last_edit_index | int if last_edit_index is not none else -1 %}
    {% set object_form_index = edit_object_index if edit_object_index >= 0 else (current_group.data.objects | length if current_group.data and current_group.data.objects else 0) %}

    <fieldset
      id="object-edit-panel"
      class="object-edit-fieldset"
      tabindex="-1"
      style="border: 2px solid #4CAF50; scroll-margin-top: 18px;"
    >
      <legend>
        Edi√ß√£o do Item ‚Äî {{ current_object.name if current_object and current_object.name else 'Novo Item' }}
      </legend>

      <p style="font-size: 13px; color: #555; margin-bottom: 12px;">
        Grupo selecionado: <strong>{{ active_group.label }}</strong> ({{ active_group.sequence }}¬∫ no fluxo) ¬∑
        {% if edit_object_index >= 0 %}
          Editando item #{{ edit_object_index + 1 }}
        {% else %}
          Criando novo item
        {% endif %}
      </p>

      <!-- Formulario de Item -->
      <h4>Dados do Item</h4>

      <div class="object-edit-grid-3" style="margin-bottom: 12px;">
        <div>
          <label><strong>Nome do Item *</strong></label>
          <input 
            type="text" 
            name="object_name" 
            required 
            placeholder="Ex: Query de Elegibilidade de Frete"
            value="{{ current_object.name if current_object else '' }}"
            style="width: 100%;"
          >
        </div>

        <div>
          <label><strong>Tabela OTM *</strong></label>
          <select
            name="object_type"
            id="object_type"
            class="form-control object-type-selector"
            required
            style="width: 100%;"
            {% if current_object and current_object.object_type %}
              data-current-type="{{ current_object.object_type }}"
            {% endif %}
          >
            <option value="">‚Äî Selecione ‚Äî</option>
            <!-- Op√ß√µes ser√£o injetadas por schema-engine.js -->
          </select>
        </div>
        <div>
          <label><strong>Dom√≠nio *</strong></label>
          <input
            list="domain-name-list"
            name="object_domain_name"
            required
            placeholder="Ex: BAU"
            value="{{ (current_object.domainName or current_object.domain) if current_object else '' }}"
            style="width: 100%;"
          >
          <datalist id="domain-name-list">
            {% for domain in data.domain_stats.domain_names %}
              <option value="{{ domain }}">
            {% endfor %}
          </datalist>
        </div>
      </div>

      <div>
        <label>Descri√ß√£o Funcional</label>
        <textarea 
          name="object_description" 
          rows="3" 
          placeholder="Explique o prop√≥sito funcional deste item no projeto"
          style="width: 100%; padding: 6px; font-family: Arial, sans-serif; font-size: 12px; border: 1px solid #ccc; border-radius: 3px;"
        >{{ current_object.description if current_object else '' }}</textarea>
      </div>

      <!-- ========================================== -->
      <!-- SAVED QUERY (somente para tipo SAVED_QUERY) -->
      <!-- ========================================== -->
      <div id="saved_query_block" style="display: none; margin-bottom: 12px;">
        <label><strong>Saved Query (SQL) *</strong></label>
        <textarea 
          name="saved_query_sql" 
          id="saved_query_sql"
          rows="8" 
          placeholder="Digite o SQL da saved query aqui..."
          style="width: 100%; padding: 8px; font-family: 'Courier New', monospace; font-size: 12px; border: 1px solid #ccc; border-radius: 3px; background: #f9f9f9;"
        >{{ current_object.saved_query.sql if current_object and current_object.saved_query else '' }}</textarea>
      </div>

      <!-- ========================================== -->
      <!-- STATUS (sempre vis√≠vel) - GRID LAYOUT     -->
      <!-- ========================================== -->
      <h4 style="margin-top: 12px;">Status e Configura√ß√£o</h4>
      
      <div class="object-edit-grid-5" style="margin-bottom: 12px;">
        <div>
          <label>üìù Documenta√ß√£o</label>
          <select name="status_documentation">
            {% for opt_key, opt_label in enums.status.items() %}
              <option value="{{ opt_key }}" 
                {% if current_object and current_object.status and current_object.status.documentation == opt_key %}selected{% endif %}>
                {{ opt_label }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label>üì¶ Migration Project</label>
          <select name="status_migration_project">
            {% for opt_key, opt_label in enums.status.items() %}
              <option value="{{ opt_key }}" 
                {% if current_object and current_object.status and current_object.status.migration_project == opt_key %}selected{% endif %}>
                {{ opt_label }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label>üíæ Exporta√ß√£o</label>
          <select name="status_export">
            {% for opt_key, opt_label in enums.status.items() %}
              <option value="{{ opt_key }}" 
                {% if current_object and current_object.status and current_object.status.export == opt_key %}selected{% endif %}>
                {{ opt_label }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label>üöÄ Deploy</label>
          <select name="status_deploy">
            {% for opt_key, opt_label in enums.status.items() %}
              <option value="{{ opt_key }}" 
                {% if current_object and current_object.status and current_object.status.deploy == opt_key %}selected{% endif %}>
                {{ opt_label }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label>‚úÖ Valida√ß√£o</label>
          <select name="status_validation">
            {% for opt_key, opt_label in enums.status.items() %}
              <option value="{{ opt_key }}" 
                {% if current_object and current_object.status and current_object.status.validation == opt_key %}selected{% endif %}>
                {{ opt_label }}
              </option>
            {% endfor %}
          </select>
        </div>
      </div>

      <!-- ========================================== -->
      <!-- Informacoes Tecnicas e Metadados         -->
      <!-- ========================================== -->
      <h4 style="margin-top: 12px;">Informa√ß√µes T√©cnicas</h4>

      <div class="object-edit-grid-4" style="margin-bottom: 12px;">
        <div>
          <label>üìã Tabela OTM</label>
          {% set current_otm_table = (current_object.object_type if current_object and current_object.object_type else (current_object.otm_table if current_object else '')) %}
          <input
            type="text"
            id="object_otm_table_display"
            value="{{ current_otm_table }}"
            readonly
            style="width: 100%; background-color: #f5f5f5; color: #1f2937;"
          >
          <input
            type="hidden"
            name="object_otm_table"
            id="object_otm_table"
            value="{{ current_otm_table }}"
          >
          <p style="font-size: 11px; color: #6b7280; margin: 4px 0 0 0;">
            Campo espelho, sincronizado automaticamente com "Tabela OTM".
          </p>
          {% set current_otm_related_tables = current_object.otm_related_tables if current_object and current_object.otm_related_tables is iterable and current_object.otm_related_tables is not string else [] %}
          {% set current_otm_subtables = current_object.otm_subtables if current_object and current_object.otm_subtables is iterable and current_object.otm_subtables is not string else [] %}
          <input type="hidden" name="object_related_tables_present" value="1">
          <input type="hidden" name="object_subtable_selection_present" value="1">
          <label style="margin-top: 8px; display: block;">Tabelas relacionadas (FROM)</label>
          <div
            id="related-tables-selector"
            style="border: 1px solid #d1d5db; border-radius: 6px; background-color: #ffffff; padding: 8px; min-height: 58px;"
          >
            <p style="margin: 0; font-size: 11px; color: #6b7280;">
              A lista ser√° carregada a partir da Query de Extra√ß√£o de Objetos.
            </p>
          </div>
          <div id="related-tables-hidden-inputs"></div>
          <p style="font-size: 11px; color: #6b7280; margin: 6px 0 0 0;">
            Marque como subtabela apenas as tabelas relacionadas que devem entrar no cache deste item.
          </p>

          <div style="margin-top: 10px;">
            {% set ignore_value = (current_object.ignore_table|string|lower) if current_object and current_object.ignore_table is defined else '' %}
            <label style="display: inline-flex; align-items: center; gap: 8px; font-weight: 600; white-space: nowrap;">
          <input
            type="checkbox"
            name="object_ignore_table"
            value="1"
            {% if ignore_value in ['1', 'true', 'on', 'yes', 'y'] %}checked{% endif %}
          >
          <input type="hidden" name="object_ignore_table_present" value="1">
          Ignorar tabela no projeto
        </label>
            <p style="font-size: 11px; color: #6b7280; margin: 4px 0 0 0;">
              Remove esta tabela da pendencia automatica de cobertura e move o item para o grupo IGNORADOS.
            </p>
          </div>
        </div>

        <div>
          <label>üöÄ Tipo de Deploy</label>
          <select name="object_deployment_type" style="width: 100%;">
            <option value="" {% if not current_object or not current_object.deployment_type %}selected{% endif %}>-- Selecione --</option>
            {% for opt in enums.deployment_type %}
              <option value="{{ opt }}" {% if current_object and current_object.deployment_type == opt %}selected{% endif %}>
                {{ opt }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label>Respons√°vel</label>
          <input type="text" name="object_responsible" value="{{ current_object.responsible if current_object else '' }}" style="width: 100%;">
        </div>

        <div>
          <label>Migration Project ID</label>
          <input type="text" name="identifiers[migration_project_id]" placeholder="ID do projeto" value="{{ current_object.identifiers.migration_project_id if current_object and current_object.identifiers else '' }}" style="width: 100%;">
        </div>
      </div>
      <div style="margin-bottom: 12px;">
        <label>üìù Notas</label>
        <textarea 
          name="object_notes" 
          rows="2" 
          placeholder="Observa√ß√µes adicionais sobre este item"
          style="width: 100%; padding: 6px; font-family: Arial, sans-serif; font-size: 12px; border: 1px solid #ccc; border-radius: 3px;"
        >{{ current_object.notes if current_object else '' }}</textarea>
      </div>

      <!-- ========================================== -->
      <!-- Identificadores para Tipos L√≥gicos       -->
      <!-- ========================================== -->
      <h4 style="margin-top: 16px;">Identificadores (Tipos L√≥gicos)</h4>

      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(0, 1fr)); gap: 12px; width: 100%; max-width: 100%;">
        <!-- SAVED_QUERY -->
        <div id="identifier_query_name" style="display:none;">
          <label>Query Name</label>
          <input type="text" name="identifiers[query_name]" placeholder="Nome da query" value="" style="width: 100%;">
        </div>

        <!-- AGENT -->
        <div id="identifier_agent_gid" style="display:none;">
          <label>Agent GID</label>
          <input type="text" name="identifiers[agent_gid]" placeholder="Identificador do agente" value="" style="width: 100%;">
        </div>

        <!-- FINDER_SET -->
        <div id="identifier_finder_set_gid" style="display:none;">
          <label>Finder Set GID</label>
          <input type="text" name="identifiers[finder_set_gid]" placeholder="Identificador do Finder Set" value="" style="width: 100%;">
        </div>

        <!-- RATE -->
        <div id="identifier_rate_offering_gid" style="display:none;">
          <label>Rate Offering GID</label>
          <input type="text" name="identifiers[rate_offering_gid]" placeholder="Identificador da taxa de oferta" value="" style="width: 100%;">
        </div>

        <!-- EVENT_GROUP -->
        <div id="identifier_event_group_gid" style="display:none;">
          <label>Event Group GID</label>
          <input type="text" name="identifiers[event_group_gid]" placeholder="Identificador do grupo de eventos" value="" style="width: 100%;">
        </div>
      </div>

      <!-- ========================================== -->
      <!-- Campos Schema-Driven (Tabelas OTM)       -->
      <!-- ========================================== -->
      <div id="schema-sections-container" style="display: none;">
        <!-- Ser√° preenchido dinamicamente por schema-engine.js -->
      </div>

      <!-- ========================================== -->
      <!-- Query de Extra√ß√£o de Objetos              -->
      <!-- ========================================== -->
      <fieldset style="background-color: #f5f5f5; border: 1px solid #2196F3;">
        <legend style="color: #1976D2;">üîç Query de Extra√ß√£o de Objetos</legend>

        <input type="hidden" name="object_extraction_query_language" value="SQL">
        <p style="font-size: 11px; color: #0d47a1; margin: 0 0 8px 0;">
          Linguagem da Query: <strong>SQL</strong>
        </p>

        <label style="margin-top: 12px;"><strong>Query SQL de Extra√ß√£o:</strong></label>
        <textarea
          name="object_extraction_query_content"
          rows="12"
          placeholder="Cole aqui a query SQL que extrai os objetos OTM para este item..."
          style="font-family: 'Courier New', monospace; font-size: 12px; background-color: #263238; color: #aed581; padding: 12px; border: 1px solid #37474f; width: 100%; max-width: 100%;"
        >{{ current_object.object_extraction_query.content if current_object and current_object.object_extraction_query and current_object.object_extraction_query.content is not none else (current_object.saved_query.sql if current_object and current_object.saved_query and current_object.saved_query.sql is not none else '') }}</textarea>
        
        <p style="font-size: 11px; color: #666; margin-top: 8px;">
          üí° Esta query √© usada para extrair objetos OTM e gerar o cache local do item de migra√ß√£o.
        </p>
      </fieldset>

      <fieldset style="background-color: #f7f7f7; border: 1px solid #9e9e9e;">
        <legend style="color: #424242;">üß† Conte√∫do T√©cnico</legend>

        <label><strong>Tipo:</strong></label>
        <select name="technical_content_type" style="max-width: 220px;">
          <option value="NONE" {% if not current_object or not current_object.technical_content or current_object.technical_content.type == 'NONE' %}selected{% endif %}>Nenhum</option>
          <option value="TEXT" {% if current_object and current_object.technical_content and current_object.technical_content.type == 'TEXT' %}selected{% endif %}>Texto T√©cnico</option>
          <option value="SCRIPT" {% if current_object and current_object.technical_content and current_object.technical_content.type == 'SCRIPT' %}selected{% endif %}>Script</option>
          <option value="RULE" {% if current_object and current_object.technical_content and current_object.technical_content.type == 'RULE' %}selected{% endif %}>Regra</option>
        </select>

        <label style="margin-top: 12px;"><strong>Conte√∫do T√©cnico (opcional):</strong></label>
        <textarea
          name="technical_content_content"
          rows="6"
          placeholder="Adicione aqui observa√ß√µes t√©cnicas, regras, snippets ou orienta√ß√µes de implementa√ß√£o..."
          style="font-family: 'Courier New', monospace; font-size: 12px; background-color: #1f2937; color: #f9fafb; padding: 12px; border: 1px solid #4b5563; width: 100%; max-width: 100%;"
        >{{ current_object.technical_content.content if current_object and current_object.technical_content and current_object.technical_content.content is not none else '' }}</textarea>
      </fieldset>

      <!-- Hidden field para manter active_group_id no POST -->
      <input type="hidden" name="active_group_id" value="{{ project.active_group_id if project else '' }}">
      <input type="hidden" name="active_group_index" value="{{ active_group_index.value if active_group_index.value is not none else '' }}">

      <!-- Hidden field para manter edit_object_index no POST -->
      <input type="hidden" name="edit_object_index" value="{{ edit_object_index if edit_object_index >= 0 else '' }}">

      <!-- Secao de Acoes do Item -->
      {% if edit_object_index >= 0 %}
        <div style="margin-top: 24px; padding: 16px; background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 4px;">
          <p style="font-size: 12px; color: #856404; margin: 0 0 12px 0;">
            <strong>A√ß√µes Dispon√≠veis:</strong>
          </p>

          <div class="object-edit-actions" style="display: grid; grid-template-columns: auto minmax(0, 1fr) auto; gap: 12px; align-items: center; width: 100%;">
            <!-- Botao Salvar Item -->
            <button type="submit" name="action" value="save_object" style="background-color: #4CAF50; color: white; padding: 8px 14px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; white-space: nowrap;">
              üíæ Salvar Item
            </button>

            <!-- Mover item para outro grupo -->
            <div class="action-inline-form" style="display: grid; grid-template-columns: auto auto auto; gap: 8px; align-items: center; margin: 0; min-width: 0; width: auto; justify-self: start;">
              <label style="font-size: 12px; margin: 0; white-space: nowrap;">Mover para:</label>
              <select id="move-to-group-id" style="width: clamp(270px, 30vw, 360px); min-width: 270px; max-width: 360px; box-sizing: border-box; padding: 6px 10px; font-size: 12px; border-radius: 3px; border: 1px solid #ccc;">
                <option value="">-- Selecione o grupo --</option>
                {% if project and project.groups %}
                  {% for g in project.groups %}
                    {% if g.group_id != project.active_group_id %}
                      <option value="{{ g.group_id }}">{{ g.label }}</option>
                    {% endif %}
                  {% endfor %}
                {% endif %}
              </select>
              <button type="button" onclick="submitMoveObject({{ edit_object_index }})" style="background-color: #FF9800; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px; white-space: nowrap;">
                ‚û°Ô∏è Mover
              </button>
            </div>

            <!-- Botao Remover (formulario separado) -->
            <div class="action-inline-form" style="display: inline; margin: 0;">
              <button type="button" onclick="if(confirm('Tem certeza que deseja remover este item?')) submitProjectAction({'remove_object_index': '{{ edit_object_index }}', 'active_group_id': '{{ project.active_group_id if project else '' }}'})" style="background-color: #e53935; color: white; padding: 8px 14px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; white-space: nowrap;">
                üóëÔ∏è Remover Item
              </button>
            </div>
          </div>

          <p style="font-size: 11px; color: #856404; margin-top: 8px;">
            üí° Use "Salvar Item" para gravar altera√ß√µes | "Mover" transfere o item para outro grupo | "Remover" exclui permanentemente.
          </p>
        </div>
      {% endif %}
    </fieldset>
  {% else %}
    <p style="color: #999;">
      Selecione um grupo ativo para come√ßar a edi√ß√£o.
    </p>
  {% endif %}

  <div style="display: flex; gap: 10px; align-items: center; flex-wrap: nowrap; overflow-x: auto; white-space: nowrap;">
    <button type="submit" name="action" value="save_project">Salvar Projeto</button>
    <button
      type="button"
      id="update-tables-btn"
      style="background-color: #1565C0;"
    >
      Atualizar Tabelas
    </button>
    <button
      type="button"
      id="update-object-cache-all-btn"
      style="background-color: #00695C;"
    >
      Atualizar Cache (Todos)
    </button>
    <button
      type="button"
      id="update-object-cache-group-btn"
      style="background-color: #2E7D32;"
      {% if not project or not project.active_group_id %}disabled{% endif %}
    >
      Atualizar Cache (Grupo Ativo)
    </button>
    <button
      type="button"
      id="update-object-cache-object-btn"
      style="background-color: #1565C0;"
      {% if not current_object %}disabled{% endif %}
    >
      Atualizar Cache (Item em Edi√ß√£o)
    </button>
  </div>

  <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-top: 8px;">
    <span id="update-tables-status" style="font-size: 12px; color: #1f2937;"></span>
    <span id="update-object-cache-status" style="font-size: 12px; color: #1f2937;"></span>
  </div>
  <p style="font-size: 11px; color: #666; margin-top: 6px;">
    Grupo ativo: <strong>{{ groups_catalog.get(project.active_group_id).label if project and project.active_group_id and groups_catalog.get(project.active_group_id) else "-" }}</strong> |
    Item em edi√ß√£o: <strong>{{ current_object.name if current_object else "-" }}</strong>
  </p>
</form>

<!-- Injetar dados do projeto para reidrata√ß√£o -->
<div id="existing-project-data" style="display: none;">
  {{ project | tojson | safe }}
</div>

<script src="{{ url_for('static', filename='js/schema-engine.js') }}"></script>
<script src="{{ url_for('static', filename='js/app.js') }}"></script>

<!-- Injeta dados do item existente para SchemaEngine -->
<script>
  // Disponibilizar dados de edi√ß√£o para SchemaEngine
  {% if current_object and current_object.data %}
    window.ExistingObjectData = {{ current_object.data | tojson | safe }};
  {% else %}
    window.ExistingObjectData = {};
  {% endif %}
  
  // Log para debug
  console.log("[Template] Dados do item existente:", window.ExistingObjectData);

  const submitProjectAction = (fields) => {
    const form = document.getElementById("project-form");
    if (!form) {
      return;
    }

    form.querySelectorAll('input[data-dynamic-action="1"]').forEach((node) => node.remove());

    Object.entries(fields || {}).forEach(([name, value]) => {
      if (value === undefined || value === null) {
        return;
      }
      const normalizedValue = String(value);
      const existingHidden = Array.from(form.elements).find(
        (element) =>
          element &&
          element.name === name &&
          element.tagName === "INPUT" &&
          element.type === "hidden" &&
          element.getAttribute("data-dynamic-action") !== "1"
      );

      if (existingHidden) {
        existingHidden.value = normalizedValue;
        return;
      }

      const hidden = document.createElement("input");
      hidden.type = "hidden";
      hidden.name = name;
      hidden.value = normalizedValue;
      hidden.setAttribute("data-dynamic-action", "1");
      form.appendChild(hidden);
    });

    form.submit();
  };

    const submitMoveObject = (editIndex) => {
    const targetSelect = document.getElementById("move-to-group-id");
    const targetGroup = targetSelect && typeof targetSelect.value === "string"
      ? targetSelect.value.trim()
      : "";
    if (!targetGroup) {
      window.alert("Selecione o grupo de destino para mover o item.");
      return;
    }
    submitProjectAction({
      move_object_index: String(editIndex),
      move_to_group_id: targetGroup,
      active_group_id: "{{ project.active_group_id if project else '' }}",
    });
  };

  window.submitProjectAction = submitProjectAction;
  window.submitMoveObject = submitMoveObject;

    const activeGroupIdFromPage = {{ (project.active_group_id if project and project.active_group_id else "") | tojson }};
    const activeGroupLabelFromPage = {{ (groups_catalog.get(project.active_group_id).label if project and project.active_group_id and groups_catalog.get(project.active_group_id) else "") | tojson }};
    const currentMigrationItemNameFromPage = {{ (current_object.name if current_object else "") | tojson }};
    const currentMigrationItemIdFromPage = {{ (current_object.migration_item_id if current_object and current_object.migration_item_id else "") | tojson }};
    const currentRelatedTablesFromPage = {{ (current_object.otm_related_tables if current_object and current_object.otm_related_tables is iterable and current_object.otm_related_tables is not string else []) | tojson }};
    const currentSubtablesFromPage = {{ (current_object.otm_subtables if current_object and current_object.otm_subtables is iterable and current_object.otm_subtables is not string else []) | tojson }};

    document.addEventListener("DOMContentLoaded", () => {
      const editPanel = document.getElementById("object-edit-panel");
    if (editPanel && window.location.hash === "#object-edit-panel") {
      editPanel.scrollIntoView({ behavior: "smooth", block: "start" });
      window.setTimeout(() => {
        editPanel.focus({ preventScroll: true });
      }, 50);
    }

      const objectTypeSelect = document.querySelector('select[name="object_type"]');
      const otmTableDisplay = document.getElementById("object_otm_table_display");
      const otmTableHidden = document.getElementById("object_otm_table");
      const toggleChangeHistoryBtn = document.getElementById("toggle-change-history-btn");
      const changeHistoryContent = document.getElementById("change-history-content");
      const toggleProjectGroupsBtn = document.getElementById("toggle-project-groups-btn");
      const projectGroupsContent = document.getElementById("project-groups-content");
      const toggleGroupObjectsBtn = document.getElementById("toggle-group-objects-btn");
      const groupObjectsContent = document.getElementById("group-objects-content");

      if (toggleChangeHistoryBtn && changeHistoryContent) {
        const storageKey = "omni.changeHistoryCollapsed";
        const applyChangeHistoryState = (collapsed) => {
          changeHistoryContent.style.display = collapsed ? "none" : "block";
          toggleChangeHistoryBtn.textContent = collapsed ? "Expandir lista" : "Recolher lista";
          toggleChangeHistoryBtn.setAttribute("aria-expanded", collapsed ? "false" : "true");
        };

        let initialCollapsed = false;
        try {
          initialCollapsed = window.sessionStorage.getItem(storageKey) === "1";
        } catch (err) {
          initialCollapsed = false;
        }
        applyChangeHistoryState(initialCollapsed);

        toggleChangeHistoryBtn.addEventListener("click", () => {
          const isExpanded = toggleChangeHistoryBtn.getAttribute("aria-expanded") === "true";
          const collapsedNow = isExpanded;
          applyChangeHistoryState(collapsedNow);
          try {
            window.sessionStorage.setItem(storageKey, collapsedNow ? "1" : "0");
          } catch (err) {
            // Ignora indisponibilidade de storage no browser.
          }
        });
      }

      if (toggleProjectGroupsBtn && projectGroupsContent) {
        const storageKey = "omni.projectGroupsCollapsed";
        const applyProjectGroupsState = (collapsed) => {
          projectGroupsContent.style.display = collapsed ? "none" : "block";
          toggleProjectGroupsBtn.textContent = collapsed ? "Expandir lista" : "Recolher lista";
          toggleProjectGroupsBtn.setAttribute("aria-expanded", collapsed ? "false" : "true");
        };

        let initialCollapsed = false;
        try {
          initialCollapsed = window.sessionStorage.getItem(storageKey) === "1";
        } catch (err) {
          initialCollapsed = false;
        }
        applyProjectGroupsState(initialCollapsed);

        toggleProjectGroupsBtn.addEventListener("click", () => {
          const isExpanded = toggleProjectGroupsBtn.getAttribute("aria-expanded") === "true";
          const collapsedNow = isExpanded;
          applyProjectGroupsState(collapsedNow);
          try {
            window.sessionStorage.setItem(storageKey, collapsedNow ? "1" : "0");
          } catch (err) {
            // Ignora indisponibilidade de storage no browser.
          }
        });
      }

      if (toggleGroupObjectsBtn && groupObjectsContent) {
        const storageKey = "omni.groupObjectsCollapsed";
        const applyGroupObjectsState = (collapsed) => {
          groupObjectsContent.style.display = collapsed ? "none" : "block";
          toggleGroupObjectsBtn.textContent = collapsed ? "Expandir lista" : "Recolher lista";
          toggleGroupObjectsBtn.setAttribute("aria-expanded", collapsed ? "false" : "true");
        };

        let initialCollapsed = false;
        try {
          initialCollapsed = window.sessionStorage.getItem(storageKey) === "1";
        } catch (err) {
          initialCollapsed = false;
        }
        applyGroupObjectsState(initialCollapsed);

        toggleGroupObjectsBtn.addEventListener("click", () => {
          const isExpanded = toggleGroupObjectsBtn.getAttribute("aria-expanded") === "true";
          const collapsedNow = isExpanded;
          applyGroupObjectsState(collapsedNow);
          try {
            window.sessionStorage.setItem(storageKey, collapsedNow ? "1" : "0");
          } catch (err) {
            // Ignora indisponibilidade de storage no browser.
          }
        });
      }

      const syncOtmTableFromObjectType = () => {
      if (!objectTypeSelect || !otmTableDisplay || !otmTableHidden) {
        return;
      }
      const selectedType = (objectTypeSelect.value || "").trim();
      otmTableDisplay.value = selectedType;
      otmTableHidden.value = selectedType;
    };

    const extractionQueryTextarea = document.querySelector('textarea[name="object_extraction_query_content"]');
    const relatedTablesSelector = document.getElementById("related-tables-selector");
    const relatedTablesHiddenInputs = document.getElementById("related-tables-hidden-inputs");

    const normalizeTableName = (value) => String(value || "").trim().toUpperCase();

    const normalizeTableIdentifier = (rawIdentifier) => {
      let token = String(rawIdentifier || "").trim();
      if (!token) {
        return "";
      }

      token = token.replace(/\)+$/, "").split("@", 1)[0].trim();
      if (!token) {
        return "";
      }

      if (token.startsWith('"') && token.endsWith('"') && token.length >= 2) {
        token = token.slice(1, -1);
      }

      const parts = token
        .split(".")
        .map((part) => part.trim())
        .filter(Boolean);
      if (!parts.length) {
        return "";
      }

      return normalizeTableName(parts[parts.length - 1]);
    };

    const splitTopLevelByComma = (text) => {
      const source = String(text || "");
      const parts = [];
      let current = "";
      let depth = 0;
      let inString = false;

      for (let idx = 0; idx < source.length; idx += 1) {
        const char = source[idx];
        const nextChar = idx + 1 < source.length ? source[idx + 1] : "";

        if (inString) {
          current += char;
          if (char === "'" && nextChar === "'") {
            current += nextChar;
            idx += 1;
            continue;
          }
          if (char === "'") {
            inString = false;
          }
          continue;
        }

        if (char === "'") {
          current += char;
          inString = true;
          continue;
        }

        if (char === "(") {
          current += char;
          depth += 1;
          continue;
        }

        if (char === ")") {
          current += char;
          depth = Math.max(depth - 1, 0);
          continue;
        }

        if (char === "," && depth === 0) {
          const segment = current.trim();
          if (segment) {
            parts.push(segment);
          }
          current = "";
          continue;
        }

        current += char;
      }

      const tail = current.trim();
      if (tail) {
        parts.push(tail);
      }
      return parts;
    };

    const extractMainFromClause = (sqlQuery) => {
      const source = String(sqlQuery || "");
      const match = source.match(
        /\bFROM\b([\s\S]*?)(?:\bWHERE\b|\bGROUP\s+BY\b|\bORDER\s+BY\b|\bHAVING\b|\bCONNECT\s+BY\b|\bSTART\s+WITH\b|\bUNION\b|\bMINUS\b|\bINTERSECT\b|$)/i
      );
      return match ? String(match[1] || "").trim() : "";
    };

    const extractRelatedTablesFromSql = (sqlQuery, primaryTableName) => {
      const fromClause = extractMainFromClause(sqlQuery);
      if (!fromClause) {
        return [];
      }

      const primaryTable = normalizeTableName(primaryTableName);
      const seen = new Set();
      const results = [];
      const segments = splitTopLevelByComma(fromClause);
      const targets = segments.length ? segments : [fromClause];

      const pushTable = (rawTable) => {
        const normalized = normalizeTableIdentifier(rawTable);
        if (!normalized || normalized === primaryTable || seen.has(normalized)) {
          return;
        }
        seen.add(normalized);
        results.push(normalized);
      };

      targets.forEach((segment) => {
        const segmentText = String(segment || "").trim();
        if (!segmentText || segmentText.startsWith("(")) {
          return;
        }

        const baseMatch = segmentText.match(/^\s*(?:ONLY\s*\(\s*)?([A-Z0-9_.$"#@]+)/i);
        if (baseMatch && baseMatch[1]) {
          pushTable(baseMatch[1]);
        }

        const joinRegex = /\bJOIN\b\s+(?:ONLY\s*\(\s*)?([A-Z0-9_.$"#@]+)/gi;
        let joinMatch = joinRegex.exec(segmentText);
        while (joinMatch) {
          pushTable(joinMatch[1]);
          joinMatch = joinRegex.exec(segmentText);
        }
      });

      return results;
    };

    const renderRelatedTablesSelector = (relatedTables, selectedSubtables) => {
      if (!relatedTablesSelector || !relatedTablesHiddenInputs) {
        return;
      }

      const normalizedSelected = new Set(
        (selectedSubtables || []).map((table) => normalizeTableName(table)).filter(Boolean)
      );
      const normalizedRelated = [];
      const seenRelated = new Set();
      (relatedTables || []).forEach((table) => {
        const normalized = normalizeTableName(table);
        if (!normalized || seenRelated.has(normalized)) {
          return;
        }
        seenRelated.add(normalized);
        normalizedRelated.push(normalized);
      });

      relatedTablesSelector.innerHTML = "";
      relatedTablesHiddenInputs.innerHTML = "";

      if (!normalizedRelated.length) {
        relatedTablesSelector.innerHTML = `
          <p style="margin: 0; font-size: 11px; color: #6b7280;">
            Sem tabelas relacionadas identificadas no FROM da query.
          </p>
        `;
        return;
      }

      const tableElement = document.createElement("table");
      tableElement.style.width = "100%";
      tableElement.style.borderCollapse = "collapse";
      tableElement.style.fontSize = "12px";

      const header = document.createElement("tr");
      header.innerHTML = `
        <th style="text-align: left; padding: 6px; border-bottom: 1px solid #e5e7eb;">Tabela Relacionada</th>
        <th style="text-align: center; padding: 6px; border-bottom: 1px solid #e5e7eb; width: 120px;">Subtabela</th>
      `;
      tableElement.appendChild(header);

      normalizedRelated.forEach((tableName) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td style="padding: 6px; border-bottom: 1px solid #f3f4f6; color: #1f2937;">
            <code>${tableName}</code>
          </td>
          <td style="padding: 6px; border-bottom: 1px solid #f3f4f6; text-align: center;">
            <input
              type="checkbox"
              name="object_otm_subtables"
              value="${tableName}"
              ${normalizedSelected.has(tableName) ? "checked" : ""}
            >
          </td>
        `;
        tableElement.appendChild(row);

        const hiddenRelated = document.createElement("input");
        hiddenRelated.type = "hidden";
        hiddenRelated.name = "object_related_tables";
        hiddenRelated.value = tableName;
        relatedTablesHiddenInputs.appendChild(hiddenRelated);
      });

      relatedTablesSelector.appendChild(tableElement);
    };

    const syncRelatedTablesFromQuery = () => {
      if (!relatedTablesSelector) {
        return;
      }

      const currentPrimaryTable = normalizeTableName(
        (otmTableHidden && otmTableHidden.value) || (objectTypeSelect && objectTypeSelect.value) || ""
      );
      const sqlQuery = extractionQueryTextarea ? extractionQueryTextarea.value : "";
      const parsedRelatedTables = extractRelatedTablesFromSql(sqlQuery, currentPrimaryTable);

      let relatedTables = parsedRelatedTables;
      if (!relatedTables.length) {
        relatedTables = (Array.isArray(currentRelatedTablesFromPage) ? currentRelatedTablesFromPage : [])
          .map((table) => normalizeTableName(table))
          .filter((table) => table && table !== currentPrimaryTable);
      }

      const selectedFromUi = Array.from(
        document.querySelectorAll('input[name="object_otm_subtables"]:checked')
      ).map((checkbox) => normalizeTableName(checkbox.value));
      const selectedSubtables = selectedFromUi.length
        ? selectedFromUi
        : (Array.isArray(currentSubtablesFromPage) ? currentSubtablesFromPage : []);

      renderRelatedTablesSelector(relatedTables, selectedSubtables);
    };

    if (objectTypeSelect && otmTableDisplay && otmTableHidden) {
      objectTypeSelect.addEventListener("change", () => {
        syncOtmTableFromObjectType();
        syncRelatedTablesFromQuery();
      });
      syncOtmTableFromObjectType();
      window.setTimeout(syncOtmTableFromObjectType, 0);
      window.setTimeout(syncOtmTableFromObjectType, 120);
      window.setTimeout(syncOtmTableFromObjectType, 600);
    }

    if (extractionQueryTextarea) {
      extractionQueryTextarea.addEventListener("input", syncRelatedTablesFromQuery);
      extractionQueryTextarea.addEventListener("change", syncRelatedTablesFromQuery);
    }
    syncRelatedTablesFromQuery();

    const updateButton = document.getElementById("update-tables-btn");
    const statusLabel = document.getElementById("update-tables-status");

    if (!updateButton || !statusLabel) {
      return;
    }

    let progressIntervalId = null;

    const formatElapsed = (seconds) => {
      if (seconds < 60) {
        return `${seconds}s`;
      }
      const minutes = Math.floor(seconds / 60);
      const remaining = seconds % 60;
      return `${minutes}m ${remaining}s`;
    };

    const stopProgressFallback = () => {
      if (progressIntervalId !== null) {
        window.clearInterval(progressIntervalId);
        progressIntervalId = null;
      }
    };

    updateButton.addEventListener("click", async () => {
      const confirmed = window.confirm(
        "Deseja atualizar as estatisticas de dominio OTM?"
      );
      if (!confirmed) {
        return;
      }

      const originalText = updateButton.textContent;
      const startedAt = Date.now();
      updateButton.disabled = true;
      updateButton.textContent = "Atualizando (0s)";
      statusLabel.style.color = "#1f2937";
      statusLabel.textContent = "Processamento iniciado. Aguarde...";

      stopProgressFallback();
      progressIntervalId = window.setInterval(() => {
        const elapsedSeconds = Math.floor((Date.now() - startedAt) / 1000);
        const elapsedText = formatElapsed(elapsedSeconds);
        const dots = ".".repeat((elapsedSeconds % 3) + 1);
        updateButton.textContent = `Atualizando (${elapsedText})`;

        if (elapsedSeconds < 20) {
          statusLabel.style.color = "#1f2937";
          statusLabel.textContent = `Atualiza√ß√£o em processamento${dots} Aguarde (${elapsedText}).`;
          return;
        }

        statusLabel.style.color = "#8A6D1E";
        statusLabel.textContent = `Atualiza√ß√£o ainda em processamento${dots} Isso pode levar alguns minutos (${elapsedText}).`;
      }, 1000);

      try {
        const response = await fetch("/api/otm/update-tables", { method: "POST" });
        const payload = await response.json();

        if (!response.ok || payload.status !== "success") {
          const errorMessage = payload.message || "Falha ao atualizar estatisticas de dominio.";
          statusLabel.style.color = "#C62828";
          statusLabel.textContent = `${errorMessage} Processamento finalizado com erro.`;
          console.error("[Atualizar Tabelas] Erro:", payload);
          return;
        }

        const result = payload.result || {};
        const isValidContract = (
          result &&
          result.metadataType === "OTM_DOMAIN_TABLE_STATISTICS" &&
          Array.isArray(result.tables)
        );
        if (!isValidContract) {
          statusLabel.style.color = "#C62828";
          statusLabel.textContent = "Resposta fora do contrato esperado para estatisticas de dominio. Processamento finalizado com erro.";
          console.error("[Atualizar Tabelas] Contrato invalido:", payload);
          return;
        }

        const tableCount = Array.isArray(result.tables)
          ? result.tables.length
          : 0;

        statusLabel.style.color = "#2E7D32";
        statusLabel.textContent = `Atualizacao de estatisticas concluida com sucesso. ${tableCount} tabela(s) com contagem disponivel.`;

        if (window.SchemaEngine && typeof window.SchemaEngine.loadTables === "function") {
          await window.SchemaEngine.loadTables();
          if (typeof window.SchemaEngine.populateObjectTypeSelector === "function") {
            window.SchemaEngine.populateObjectTypeSelector();
          }
        }
      } catch (error) {
        statusLabel.style.color = "#C62828";
        statusLabel.textContent = "Erro de comunicacao ao atualizar estatisticas de dominio. Processamento finalizado com erro.";
        console.error("[Atualizar Tabelas] Erro inesperado:", error);
      } finally {
        stopProgressFallback();
        updateButton.disabled = false;
        updateButton.textContent = originalText;
      }
    });

    const cacheAllButton = document.getElementById("update-object-cache-all-btn");
    const cacheGroupButton = document.getElementById("update-object-cache-group-btn");
    const cacheObjectButton = document.getElementById("update-object-cache-object-btn");
    const cacheStatusLabel = document.getElementById("update-object-cache-status");

    const cacheButtons = [cacheAllButton, cacheGroupButton, cacheObjectButton].filter(Boolean);
    const cacheDefaultDisabledState = new Map(
      cacheButtons.map((button) => [button, Boolean(button.disabled)])
    );
    let cacheProgressIntervalId = null;

    const stopCacheProgressFallback = () => {
      if (cacheProgressIntervalId !== null) {
        window.clearInterval(cacheProgressIntervalId);
        cacheProgressIntervalId = null;
      }
    };

    const setCacheButtonsRunning = (isRunning) => {
      cacheButtons.forEach((button) => {
        if (isRunning) {
          button.disabled = true;
          return;
        }
        button.disabled = cacheDefaultDisabledState.get(button) === true;
      });
    };

    const runObjectCacheAction = async (scope, triggerButton, confirmMessage, requestBody) => {
      if (!triggerButton || !cacheStatusLabel) {
        return;
      }

      const confirmed = window.confirm(confirmMessage);
      if (!confirmed) {
        return;
      }

      const originalText = triggerButton.textContent;
      const startedAt = Date.now();
      setCacheButtonsRunning(true);
      triggerButton.textContent = "Executando (0s)";
      cacheStatusLabel.style.color = "#1f2937";
      cacheStatusLabel.textContent = "Processamento iniciado. Aguarde...";

      stopCacheProgressFallback();
      cacheProgressIntervalId = window.setInterval(() => {
        const elapsedSeconds = Math.floor((Date.now() - startedAt) / 1000);
        const elapsedText = formatElapsed(elapsedSeconds);
        const dots = ".".repeat((elapsedSeconds % 3) + 1);
        triggerButton.textContent = `Executando (${elapsedText})`;

        if (elapsedSeconds < 20) {
          cacheStatusLabel.style.color = "#1f2937";
          cacheStatusLabel.textContent = `Atualiza√ß√£o de cache em processamento${dots} Aguarde (${elapsedText}).`;
          return;
        }

        cacheStatusLabel.style.color = "#8A6D1E";
        cacheStatusLabel.textContent = `Atualiza√ß√£o de cache ainda em processamento${dots} Isso pode levar alguns minutos (${elapsedText}).`;
      }, 1000);

      try {
        const response = await fetch("/api/otm/update-object-cache", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(requestBody),
        });
        const payload = await response.json();

        if (!response.ok || payload.status === "error") {
          const errorMessage = payload.message || "Falha ao atualizar cache de itens.";
          cacheStatusLabel.style.color = "#C62828";
          cacheStatusLabel.textContent = `${errorMessage} Processamento finalizado com erro.`;
          console.error(`[Atualizar Cache][${scope}] Erro:`, payload);
          return;
        }

        const result = payload.result || {};
        const pickMetric = (...candidates) => {
          for (const candidate of candidates) {
            if (candidate !== undefined && candidate !== null && candidate !== "") {
              return Number(candidate);
            }
          }
          return 0;
        };
        const successCount = pickMetric(result.successMigrationItems, result.successCount, 0);
        const skippedCount = pickMetric(result.skippedMigrationItems, result.skippedCount, 0);
        const errorCount = pickMetric(result.errorMigrationItems, result.errorCount, 0);
        const selectedMigrationItems = pickMetric(result.selectedMigrationItems, result.selectedObjects, 0);

        if (payload.status === "partial_success") {
          cacheStatusLabel.style.color = "#8A6D1E";
          cacheStatusLabel.textContent =
            `Cache atualizado parcialmente (${scope}). Selecionados: ${selectedMigrationItems}. ` +
            `Sucesso: ${successCount}, Ignorados: ${skippedCount}, Erros: ${errorCount}.`;
          return;
        }

        cacheStatusLabel.style.color = "#2E7D32";
        cacheStatusLabel.textContent =
          `Cache atualizado com sucesso (${scope}). Selecionados: ${selectedMigrationItems}. ` +
          `Sucesso: ${successCount}, Ignorados: ${skippedCount}, Erros: ${errorCount}.`;
      } catch (error) {
        cacheStatusLabel.style.color = "#C62828";
        cacheStatusLabel.textContent = "Erro de comunicacao ao atualizar cache de itens. Processamento finalizado com erro.";
        console.error(`[Atualizar Cache][${scope}] Erro inesperado:`, error);
      } finally {
        stopCacheProgressFallback();
        setCacheButtonsRunning(false);
        triggerButton.textContent = originalText;
      }
    };

    if (cacheAllButton) {
      cacheAllButton.addEventListener("click", async () => {
        await runObjectCacheAction(
          "todos",
          cacheAllButton,
          "Deseja atualizar o cache de todos os itens do projeto?",
          { scope: "all" }
        );
      });
    }

    if (cacheGroupButton) {
      cacheGroupButton.addEventListener("click", async () => {
        const groupId = String(activeGroupIdFromPage || "").trim();
        if (!groupId) {
          window.alert("Nao existe grupo ativo para executar esta acao.");
          return;
        }

        await runObjectCacheAction(
          "grupo ativo",
          cacheGroupButton,
          `Deseja atualizar o cache dos itens do grupo ativo (${activeGroupLabelFromPage || "sem nome"})?`,
          { scope: "migration_group", migration_group_id: groupId }
        );
      });
    }

    if (cacheObjectButton) {
      cacheObjectButton.addEventListener("click", async () => {
        const migrationItemName = String(currentMigrationItemNameFromPage || "").trim();
        const migrationItemId = String(currentMigrationItemIdFromPage || "").trim();
        const groupId = String(activeGroupIdFromPage || "").trim();
        if (!migrationItemName && !migrationItemId) {
          window.alert("Nao existe item em edicao para executar esta acao.");
          return;
        }

        const requestBody = { scope: "migration_item" };
        if (migrationItemId) {
          requestBody.migration_item_id = migrationItemId;
        } else if (migrationItemName) {
          requestBody.migration_item_name = migrationItemName;
        }
        if (groupId && !migrationItemId) {
          requestBody.migration_group_id = groupId;
        }

        await runObjectCacheAction(
          "item em edi√ß√£o",
          cacheObjectButton,
          `Deseja atualizar o cache do item em edicao (${migrationItemName || "sem nome"})?`,
          requestBody
        );
      });
    }
  });
</script>

</body>
</html>
