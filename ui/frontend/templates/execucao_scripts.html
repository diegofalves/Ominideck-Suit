<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OmniDeck | Central de Scripts</title>
  <style>
    :root {
      --bg: #081425;
      --ink: #10213e;
      --muted: #5b6e8b;
      --brand: #0f67ff;
      --brand-2: #0047c2;
      --line: #d6e1f2;
      --card: #ffffff;
      --ok: #0f8c56;
      --err: #c62828;
      --radius-lg: 16px;
      --radius-md: 12px;
      --shadow: 0 16px 32px rgba(16, 33, 62, 0.08);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      min-height: 100vh;
      font-family: "Segoe UI", Tahoma, sans-serif;
      color: var(--ink);
      background:
        radial-gradient(circle at 8% -10%, #0f67ff40 0%, transparent 45%),
        var(--bg);
      padding: 20px;
    }

    .container { max-width: 1240px; margin: 0 auto; }

    .header {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: flex-start;
      margin-bottom: 14px;
    }

    .title h1 {
      font-size: clamp(1.5rem, 4vw, 2rem);
      margin-bottom: 4px;
      color: #e9f1ff;
    }

    .title p {
      color: #c3d7f4;
      max-width: 70ch;
      line-height: 1.45;
      font-size: 0.95rem;
    }

    .nav {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .nav a {
      text-decoration: none;
      color: var(--brand-2);
      font-weight: 700;
      font-size: 0.86rem;
      border: 1px solid #bed0ef;
      background: #fff;
      border-radius: 999px;
      padding: 7px 12px;
    }

    .helper {
      background: #f7faff;
      border: 1px solid var(--line);
      border-radius: var(--radius-lg);
      padding: 12px 14px;
      margin-bottom: 14px;
      box-shadow: var(--shadow);
    }

    .helper p {
      color: #2f466e;
      font-size: 0.92rem;
      line-height: 1.45;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
      margin-bottom: 14px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      padding: 14px;
    }

    .tag {
      display: inline-block;
      font-size: 0.74rem;
      font-weight: 800;
      letter-spacing: 0.06em;
      color: #274a7f;
      background: #eaf2ff;
      border-radius: 999px;
      padding: 4px 8px;
      margin-bottom: 8px;
    }

    .card h2 {
      font-size: 1.06rem;
      margin-bottom: 6px;
    }

    .desc {
      color: var(--muted);
      font-size: 0.92rem;
      line-height: 1.48;
      margin-bottom: 8px;
    }

    .use {
      background: #f8fbff;
      border: 1px solid #d9e6fa;
      border-radius: 10px;
      padding: 8px;
      margin-bottom: 10px;
      font-size: 0.86rem;
      color: #36507d;
    }

    .fields {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 8px;
    }

    .field { margin-bottom: 8px; }

    label {
      display: block;
      font-size: 0.8rem;
      font-weight: 700;
      color: #35507b;
      margin-bottom: 4px;
    }

    input, select {
      width: 100%;
      border: 1px solid #c4d4ec;
      border-radius: 10px;
      padding: 8px 9px;
      background: #fff;
      color: var(--ink);
      font-size: 0.9rem;
    }

    .check {
      display: flex;
      align-items: center;
      gap: 6px;
      color: #35507b;
      font-size: 0.87rem;
      margin-bottom: 7px;
    }

    .check input { width: auto; }

    button {
      border: none;
      border-radius: 10px;
      background: linear-gradient(145deg, var(--brand) 0%, var(--brand-2) 100%);
      color: #fff;
      font-weight: 800;
      font-size: 0.9rem;
      padding: 9px 12px;
      cursor: pointer;
    }

    .result {
      background: #0b1a32;
      color: #d4e5ff;
      border-radius: var(--radius-md);
      border: 1px solid #ffffff22;
      padding: 12px;
    }

    .result-head {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }

    .result-head h3 { font-size: 0.95rem; }

    .status {
      font-size: 0.85rem;
      font-weight: 800;
      border-radius: 999px;
      padding: 5px 10px;
      background: #1a2f56;
      color: #d8e8ff;
    }

    .status.ok {
      background: #10392b;
      color: #afffdd;
    }

    .status.err {
      background: #4a1f26;
      color: #ffd1d1;
    }

    pre {
      max-height: 330px;
      overflow: auto;
      background: #071226;
      border: 1px solid #ffffff1a;
      border-radius: 9px;
      padding: 9px;
      font-size: 0.8rem;
      line-height: 1.4;
      white-space: pre-wrap;
      word-break: break-word;
    }

    @media (max-width: 980px) {
      .grid { grid-template-columns: 1fr; }
      .fields { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="title">
        <h1>Central de Execução de Scripts</h1>
        <p>Use este painel para atualizar dados técnicos do OmniDeck sem precisar rodar comandos manuais no terminal.</p>
      </div>
      <nav class="nav">
        <a href="/">Home</a>
        <a href="/dashboard-documento-migracao">Dashboard de Migração</a>
      </nav>
    </header>

    <section class="helper">
      <p>
        Fluxo recomendado:
        1) Atualizar Estatísticas OTM.
        2) Atualizar Cache de Itens.
        3) Validar Tabelas Elegíveis.
        4) Gerar Catálogo SQL Agent.
        Use Traduções e Help Index quando precisar de conteúdo atualizado para consulta.
      </p>
    </section>

    <section class="grid">
      <article class="card">
        <span class="tag">BASE DO CATÁLOGO</span>
        <h2>Atualizar Estatísticas OTM</h2>
        <p class="desc">Recalcula informações gerais das tabelas OTM e atualiza os dados usados pelo sistema para análise de domínio.</p>
        <div class="use"><strong>Quando usar:</strong> após mudanças de estrutura/catálogo OTM ou antes de revisar cobertura de tabelas.</div>
        <button onclick="runAction('/api/otm/update-tables', {}, 'Atualizar Estatísticas OTM')">Executar agora</button>
      </article>

      <article class="card">
        <span class="tag">OBJETOS DE MIGRAÇÃO</span>
        <h2>Atualizar Cache de Itens</h2>
        <p class="desc">Atualiza os objetos técnicos usados no documento de migração por escopo: tudo, por grupo ou por item específico.</p>
        <div class="use"><strong>Quando usar:</strong> após inclusão/ajuste de MIGRATION_ITEMs ou para sincronizar um grupo específico.</div>

        <div class="fields">
          <div class="field">
            <label for="cache-scope">Escopo da atualização</label>
            <select id="cache-scope">
              <option value="all">Tudo (all)</option>
              <option value="migration_group">Somente 1 grupo</option>
              <option value="migration_item">Somente 1 item</option>
            </select>
          </div>
          <div class="field">
            <label for="cache-group">ID do grupo</label>
            <input id="cache-group" placeholder="Ex: PLANNING">
          </div>
        </div>

        <div class="fields">
          <div class="field">
            <label for="cache-item">Nome do item</label>
            <input id="cache-item" placeholder="Ex: BAU_AGENT_AGENTS_5_AUTOMATION">
          </div>
          <div class="field">
            <label for="cache-item-id">ID técnico do item (opcional)</label>
            <input id="cache-item-id" placeholder="Opcional">
          </div>
        </div>

        <label class="check"><input type="checkbox" id="cache-dry">Executar em modo de teste (dry run)</label>
        <button onclick="runObjectCache()">Executar agora</button>
      </article>

      <article class="card">
        <span class="tag">CONTEÚDO E IDIOMAS</span>
        <h2>Atualizar Cache de Traduções</h2>
        <p class="desc">Recarrega traduções PT/EN usadas em consultas e enriquecimento de dados no OmniDeck.</p>
        <div class="use"><strong>Quando usar:</strong> quando houver inconsistência de textos traduzidos ou atualização recente no ambiente OTM.</div>

        <label class="check"><input type="checkbox" id="tr-inc">Atualizar somente o que mudou (incremental)</label>

        <div class="fields">
          <div class="field">
            <label for="tr-timeout">Tempo máximo (segundos)</label>
            <input id="tr-timeout" type="number" min="30" value="1800">
          </div>
          <div class="field">
            <label for="tr-page">Quantidade por lote</label>
            <input id="tr-page" type="number" min="100" value="5000">
          </div>
        </div>

        <button onclick="runTranslations()">Executar agora</button>
      </article>

      <article class="card">
        <span class="tag">DOCUMENTAÇÃO OTM</span>
        <h2>Atualizar Help Index</h2>
        <p class="desc">Faz varredura da documentação Oracle OTM e atualiza os índices usados para busca e referência técnica.</p>
        <div class="use"><strong>Quando usar:</strong> quando precisar de documentação local mais recente; você pode atualizar tudo ou apenas um tipo, como Release Notes.</div>

        <div class="fields">
          <div class="field">
            <label for="help-book">Tipo de documento</label>
            <select id="help-book">
              <option value="">Todos os documentos</option>
              <option value="otmrn">Release Notes</option>
              <option value="otmca">Administration Guide</option>
              <option value="otmra">REST API Business Object Resources</option>
              <option value="otmro">REST API Data Export</option>
              <option value="otmol">Online Help</option>
              <option value="otmcg">Getting Started Guide</option>
            </select>
          </div>
          <div class="field">
            <label for="help-doc">Versão da doc (opcional)</label>
            <input id="help-doc" placeholder="Ex: 25c">
          </div>
          <div class="field">
            <label for="help-max">Limite de páginas (opcional)</label>
            <input id="help-max" type="number" min="1" placeholder="Ex: 500">
          </div>
        </div>

        <label class="check"><input type="checkbox" id="help-dry">Somente simular execução (dry run)</label>
        <label class="check"><input type="checkbox" id="help-inc">Atualização incremental</label>
        <label class="check"><input type="checkbox" id="help-index-only">Somente reconstruir índice</label>
        <button onclick="runHelpIndex()">Executar agora</button>
      </article>

      <article class="card">
        <span class="tag">QUALIDADE DO CATÁLOGO</span>
        <h2>Validar Tabelas Elegíveis</h2>
        <p class="desc">Valida o catálogo de tabelas elegíveis para migração e aponta erros de estrutura, duplicidade e tipos inválidos.</p>
        <div class="use"><strong>Quando usar:</strong> antes de publicar ajustes no catálogo de elegibilidade ou antes de execução de migração.</div>
        <button onclick="runAction('/api/scripts/validate-eligible-tables', {}, 'Validar Tabelas Elegíveis')">Executar agora</button>
      </article>

      <article class="card">
        <span class="tag">CHATGPT AGENT</span>
        <h2>Gerar Catálogo SQL Agent</h2>
        <p class="desc">Converte os schemas OTM em JSONL otimizado para consultas via ChatGPT Agent conectado ao GitHub.</p>
        <div class="use"><strong>Quando usar:</strong> após atualização de tabelas/estatísticas ou antes de publicar material de suporte SQL.</div>

        <div class="fields">
          <div class="field">
            <label for="agent-mode">Escopo do catálogo</label>
            <select id="agent-mode">
              <option value="eligible">Somente tabelas elegíveis</option>
              <option value="all">Todas as tabelas</option>
            </select>
          </div>
          <div class="field">
            <label for="agent-output">Arquivo de saída (opcional)</label>
            <input id="agent-output" placeholder="Ex: metadata/otm/agent_sql/catalog/schema_catalog_custom.jsonl">
          </div>
        </div>

        <button onclick="runAgentCatalog()">Executar agora</button>
      </article>
    </section>

    <section class="result">
      <div class="result-head">
        <h3>Resultado da última execução</h3>
        <div id="result-status" class="status">Aguardando ação</div>
      </div>
      <pre id="result-body">{}</pre>
    </section>
  </div>

  <script>
    function setResult(title, ok, data) {
      const status = document.getElementById("result-status");
      const body = document.getElementById("result-body");
      status.className = "status " + (ok ? "ok" : "err");
      status.textContent = title + " - " + (ok ? "Sucesso" : "Erro");
      body.textContent = JSON.stringify(data, null, 2);
    }

    async function runAction(url, payload, title) {
      setResult(title, true, { status: "running", message: "Executando..." });
      try {
        const response = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload || {})
        });
        const data = await response.json();
        setResult(title, response.ok, { http_status: response.status, ...data });
      } catch (error) {
        setResult(title, false, { status: "error", message: String(error) });
      }
    }

    function runObjectCache() {
      runAction("/api/otm/update-object-cache", {
        scope: document.getElementById("cache-scope").value,
        migration_group_id: document.getElementById("cache-group").value,
        migration_item_name: document.getElementById("cache-item").value,
        migration_item_id: document.getElementById("cache-item-id").value,
        dry_run: document.getElementById("cache-dry").checked
      }, "Atualizar Cache de Itens");
    }

    function runTranslations() {
      runAction("/api/scripts/update-translations-cache", {
        incremental: document.getElementById("tr-inc").checked,
        timeout: Number(document.getElementById("tr-timeout").value || 1800),
        page_size: Number(document.getElementById("tr-page").value || 5000)
      }, "Atualizar Cache de Traduções");
    }

    function runHelpIndex() {
      runAction("/api/scripts/update-help-index", {
        book_key: document.getElementById("help-book").value,
        doc_version: document.getElementById("help-doc").value,
        max_pages: document.getElementById("help-max").value ? Number(document.getElementById("help-max").value) : 0,
        dry_run: document.getElementById("help-dry").checked,
        incremental: document.getElementById("help-inc").checked,
        build_index_only: document.getElementById("help-index-only").checked
      }, "Atualizar Help Index");
    }

    function runAgentCatalog() {
      runAction("/api/scripts/build-agent-sql-catalog", {
        mode: document.getElementById("agent-mode").value,
        output_file: document.getElementById("agent-output").value
      }, "Gerar Catálogo SQL Agent");
    }
  </script>
</body>
</html>
